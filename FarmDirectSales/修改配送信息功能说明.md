# 修改配送信息功能说明

## 功能概述
为农户订单管理界面添加了"修改配送信息"功能，允许农户在订单开始配送后随时更新配送相关信息。

## 新增功能

### 1. 前端界面修改

#### 订单列表新增按钮
- **位置**: `FarmDirectSales/wwwroot/pages/farmer/orders.html`
- **新增内容**: 为状态为"货到付款配送中"的订单添加"修改配送信息"按钮
- **按钮样式**: 橙色警告样式 (`btn-warning`)，使用编辑图标 (`fa-edit`)

#### 订单详情模态框增强
- **位置**: 订单详情模态框中的操作按钮区域
- **新增内容**: 配送中订单的"开始配送"按钮改为"修改配送信息"按钮
- **交互逻辑**: 点击后打开修改配送信息模态框

#### 新增修改配送信息模态框
- **模态框ID**: `editDeliveryModal`
- **功能特性**:
  - 支持配送预设模板选择
  - 可修改配送信息备注、联系人、联系电话、预计送达时间
  - 表单验证和错误提示
  - 显示当前配送信息作为默认值

### 2. 后端API新增

#### 更新配送信息端点
- **路径**: `PUT /api/order/{id}/update-delivery`
- **控制器**: `OrderController.UpdateDeliveryInfo`
- **功能**:
  - 验证农户权限
  - 验证订单状态（仅配送中订单可修改）
  - 更新配送信息字段
  - 返回更新结果

#### 请求模型
```csharp
public class UpdateDeliveryInfoRequest
{
    [Required] public int FarmerId { get; set; }
    public string? DeliveryInfo { get; set; }
    public string? DeliveryContact { get; set; }
    public string? DeliveryPhone { get; set; }
    public string? EstimatedDeliveryTime { get; set; }
}
```

### 3. JavaScript函数新增

#### 核心函数
- `openEditDeliveryModal(orderId)`: 打开修改配送信息模态框
- `updateDeliveryInfo()`: 处理配送信息更新
- `loadEditDeliveryPresets()`: 加载配送预设到编辑模态框
- `applyEditDeliveryPreset(presetId)`: 应用配送预设到编辑表单

#### 事件绑定
- 修改配送信息按钮点击事件
- 编辑模态框中配送预设选择事件
- 确认修改按钮点击事件

## 用户交互流程

### 从订单列表修改
1. 农户在订单列表中找到配送中的订单
2. 点击"修改配送信息"按钮（橙色编辑图标）
3. 打开修改配送信息模态框，显示当前配送信息
4. 可选择配送预设或手动修改各字段
5. 点击"确认修改"提交更新
6. 系统显示成功提示并刷新订单列表

### 从订单详情修改
1. 农户点击"查看详情"打开订单详情
2. 对于配送中订单，"开始配送"按钮变为"修改配送信息"
3. 点击后关闭详情模态框，打开修改配送信息模态框
4. 后续流程同上

## 权限控制

### 前端限制
- 只有状态为"货到付款配送中"的订单才显示修改按钮
- 农户只能看到自己的订单

### 后端验证
- 验证订单是否存在
- 验证当前用户是否为该订单对应的农户
- 验证订单状态是否为"货到付款配送中"
- 只有通过所有验证才允许更新

## 技术实现细节

### 状态检查
```javascript
if (order.status === '货到付款配送中') {
    // 显示修改配送信息按钮
}
```

### API调用
```javascript
const response = await http.put(`/api/order/${orderId}/update-delivery`, updateData);
```

### 表单数据处理
- 获取表单中的配送信息
- 构建更新请求数据
- 处理API响应和错误

## 用户体验改进

### 界面友好性
- 使用不同颜色区分不同操作按钮
- 提供清晰的操作提示和说明
- 支持配送预设快速填充

### 数据同步
- 修改成功后自动刷新订单列表
- 保持界面状态一致性
- 提供即时反馈

### 错误处理
- 完善的前端表单验证
- 后端权限和状态验证
- 用户友好的错误提示

## 测试验证

### 功能测试
- ✅ 配送中订单显示修改按钮
- ✅ 非配送中订单不显示修改按钮
- ✅ 修改配送信息模态框正常打开
- ✅ 配送预设选择功能正常
- ✅ API端点响应正确

### 权限测试
- ✅ 订单状态验证正常
- ✅ 农户权限验证正常
- ✅ 错误提示信息准确

## 后续改进建议

1. **客户通知**: 配送信息更新后自动通知客户
2. **修改历史**: 记录配送信息的修改历史
3. **批量修改**: 支持批量修改多个订单的配送信息
4. **更丰富的配送状态**: 添加更多配送状态选项
5. **实时同步**: 考虑实时同步配送信息到客户端 