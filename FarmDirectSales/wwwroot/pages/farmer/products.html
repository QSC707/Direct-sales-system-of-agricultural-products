<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品管理 - 农产品直销平台</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../../js/dependencies.js"></script>
    <!-- 引入Axios库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- 引入SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- API调用相关 -->
    <script src="../../js/api.js"></script>
    <!-- Axios配置 -->
    <script src="../../js/axios-config.js"></script>
    <script src="../../js/auth.js"></script>
    <style>
        /* 批量管理相关样式 */
        #batchToolbar {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .batch-column {
            width: 40px;
        }
        
        /* 选中行的样式 */
        tr.selected {
            background-color: #e6f3ff !important;
        }
        
        /* 按钮间距 */
        #batchToolbar .btn {
            margin-right: 5px;
        }
        
        /* 上下架状态标签 */
        .badge-success {
            background-color: #28a745;
        }
        
        .badge-secondary {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">农户中心</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">农户首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">我的产品</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">订单管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">销售统计</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                            <span id="currentUsername">用户</span>
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="farm-profile.html">农场资料</a>
                            <a class="dropdown-item active" href="products.html">我的产品</a>
                            <a class="dropdown-item" href="orders.html">订单管理</a>
                            <a class="dropdown-item" href="statistics.html">销售统计</a>
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="../../index.html">返回网站首页</a>
                            <a class="dropdown-item" href="#" id="logoutBtn">退出登录</a>
                        </div>
                    </li>
                    <li class="nav-item" id="loginItem">
                        <a class="nav-link" href="../login.html">登录</a>
                    </li>
                    <li class="nav-item" id="registerItem">
                        <a class="nav-link" href="../register.html">注册</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container my-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="dashboard.html" class="list-group-item list-group-item-action">农户首页</a>
                    <a href="farm-profile.html" class="list-group-item list-group-item-action">农场资料</a>
                    <a href="products.html" class="list-group-item list-group-item-action active">我的产品</a>
                    <a href="orders.html" class="list-group-item list-group-item-action">订单管理</a>
                    <a href="statistics.html" class="list-group-item list-group-item-action">销售统计</a>
                    <a href="profile.html" class="list-group-item list-group-item-action">个人信息</a>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="col-md-9">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">我的产品</h4>
                        <div>
                            <button class="btn btn-light mr-2" id="batchManageBtn">
                                <i class="fa fa-tasks"></i> 批量管理
                            </button>
                        <button class="btn btn-light" data-toggle="modal" data-target="#addProductModal">
                            <i class="fa fa-plus"></i> 添加产品
                        </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 批量操作工具栏 -->
                        <div id="batchToolbar" class="mb-3" style="display: none;">
                            <div class="btn-group">
                                <button class="btn btn-success" id="batchActiveBtn">批量上架</button>
                                <button class="btn btn-secondary" id="batchInactiveBtn">批量下架</button>
                                <button class="btn btn-danger" id="batchDeleteBtn">批量删除</button>
                                <button class="btn btn-info" id="batchExportBtn">导出选中</button>
                                <button class="btn btn-light" id="exitBatchBtn">退出批量管理</button>
                            </div>
                        </div>
                        
                        <!-- 筛选工具栏 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="statusFilter">状态筛选：</label>
                                    <select class="form-control" id="statusFilter">
                                        <option value="all">全部商品</option>
                                        <option value="active">已上架</option>
                                        <option value="inactive">已下架</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="searchProduct">搜索商品：</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchProduct" placeholder="输入商品名称">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button" id="searchBtn">
                                                <i class="fa fa-search"></i> 搜索
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 产品列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="batch-column" style="display: none;">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="selectAllProducts">
                                                <label class="custom-control-label" for="selectAllProducts"></label>
                                            </div>
                                        </th>
                                        <th>产品图片</th>
                                        <th>名称</th>
                                        <th>价格(元/kg)</th>
                                        <th>库存(kg)</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="productList">
                                    <!-- 产品列表将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="7" class="text-center">正在加载产品...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 空状态提示 -->
                        <div id="emptyProducts" class="text-center py-5" style="display: none;">
                            <img src="../../img/empty-box.png" alt="暂无产品" class="img-fluid mb-3" style="max-width: 120px;">
                            <h5 class="text-muted">您还没有添加任何产品</h5>
                            <p class="text-muted">点击"添加产品"按钮开始添加您的第一个产品</p>
                            <button class="btn btn-primary" data-toggle="modal" data-target="#addProductModal">
                                添加产品
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加产品模态框 -->
    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addProductModalLabel">添加新产品</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="productName">产品名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="productCategory">产品类别 <span class="text-danger">*</span></label>
                                <select class="form-control" id="productCategory" required>
                                    <option value="">请选择类别</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="水果">水果</option>
                                    <option value="谷物">谷物</option>
                                    <option value="肉类">肉类</option>
                                    <option value="奶制品">奶制品</option>
                                    <option value="蛋类">蛋类</option>
                                    <option value="水产品">水产品</option>
                                    <option value="干货">干货</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="productPrice">价格(元/kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" min="0.01" step="0.01" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="productStock">库存(kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productStock" min="0" step="0.1" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">产品描述</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="productSpecification">规格说明</label>
                            <input type="text" class="form-control" id="productSpecification" placeholder="如：5kg/箱">
                        </div>
                        
                        <div class="form-group">
                            <label>产品图片 <span class="text-danger">*</span></label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="productImage" accept="image/*" required>
                                <label class="custom-file-label" for="productImage">选择文件</label>
                            </div>
                            <div class="mt-2">
                                <img id="imagePreview" src="../../img/no-image.png" alt="产品图片预览" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            <!-- 添加上传状态显示 -->
                            <div id="uploadStatus" class="mt-2 small" style="display: none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="isOrganic">
                                <label class="custom-control-label" for="isOrganic">有机认证</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="harvestDate">收获日期</label>
                            <input type="date" class="form-control" id="harvestDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="shelfLife">保质期(天)</label>
                            <input type="number" class="form-control" id="shelfLife" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="productStatus">状态</label>
                            <select class="form-control" id="productStatus">
                                <option value="上架">上架</option>
                                <option value="下架">下架</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">保存产品</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑产品模态框 -->
    <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProductModalLabel">编辑产品</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editProductName">产品名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editProductName" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editProductCategory">产品类别 <span class="text-danger">*</span></label>
                                <select class="form-control" id="editProductCategory" required>
                                    <option value="">请选择类别</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="水果">水果</option>
                                    <option value="谷物">谷物</option>
                                    <option value="肉类">肉类</option>
                                    <option value="奶制品">奶制品</option>
                                    <option value="蛋类">蛋类</option>
                                    <option value="水产品">水产品</option>
                                    <option value="干货">干货</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editProductPrice">价格(元/kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editProductPrice" min="0.01" step="0.01" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editProductStock">库存(kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editProductStock" min="0" step="0.1" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductDescription">产品描述</label>
                            <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductSpecification">规格说明</label>
                            <input type="text" class="form-control" id="editProductSpecification" placeholder="如：5kg/箱">
                        </div>
                        
                        <div class="form-group">
                            <label>产品图片</label>
                            <div class="mb-2">
                                <img id="editImagePreview" src="../../img/no-image.png" alt="产品图片预览" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="editProductImage" accept="image/*">
                                <label class="custom-file-label" for="editProductImage">选择新图片</label>
                            </div>
                            <small class="form-text text-muted">如不需更换图片请勿上传</small>
                            <div class="mt-2">
                                <img id="editImagePreview" src="../../img/no-image.png" alt="产品图片预览" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            <div id="editUploadStatus" class="mt-2 small" style="display: none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="editIsOrganic">
                                <label class="custom-control-label" for="editIsOrganic">有机认证</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editHarvestDate">收获日期</label>
                            <input type="date" class="form-control" id="editHarvestDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="editShelfLife">保质期(天)</label>
                            <input type="number" class="form-control" id="editShelfLife" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductStatus">状态</label>
                            <select class="form-control" id="editProductStatus">
                                <option value="上架">上架</option>
                                <option value="下架">下架</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="updateProductBtn">更新</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 产品详情模态框 -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="productDetailModalLabel">产品详情</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img id="detailProductImage" src="../../img/no-image.png" alt="产品图片" class="img-fluid rounded mb-3" style="max-height: 200px;">
                        </div>
                        <div class="col-md-8">
                            <h4 id="detailProductName">产品名称</h4>
                            <div class="mb-3">
                                <span id="detailProductStatus" class="badge badge-success">上架</span>
                                <span class="text-muted ml-2" id="detailProductCategory">类别</span>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>价格：</strong> <span id="detailProductPrice">¥0.00</span> 元/kg
                                </div>
                                <div class="col-6">
                                    <strong>库存：</strong> <span id="detailProductStock">0</span> kg
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h5>详细信息</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <th style="width: 150px;">创建时间</th>
                                            <td id="detailCreateTime">-</td>
                                        </tr>
                                        <tr>
                                            <th>最后更新</th>
                                            <td id="detailUpdateTime">-</td>
                                        </tr>
                                        <tr>
                                            <th>上架时间</th>
                                            <td id="detailActiveTime">-</td>
                                        </tr>
                                        <tr>
                                            <th>下架时间</th>
                                            <td id="detailInactiveTime">-</td>
                                        </tr>
                                        <tr>
                                            <th>产品描述</th>
                                            <td id="detailDescription">-</td>
                                        </tr>
                                        <tr>
                                            <th>规格说明</th>
                                            <td id="detailSpecification">-</td>
                                        </tr>
                                        <tr>
                                            <th>有机认证</th>
                                            <td id="detailIsOrganic">否</td>
                                        </tr>
                                        <tr>
                                            <th>评价信息</th>
                                            <td>
                                                <div>平均评分: <span id="detailRating">-</span></div>
                                                <div>评价数量: <span id="detailReviewCount">0</span></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger detail-delete-btn">删除产品</button>
                    <button type="button" class="btn btn-primary detail-edit-btn">编辑产品</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p>© 2023 农产品直销平台 版权所有</p>
        </div>
    </footer>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p>您确定要永久删除产品 <strong id="deleteProductName">此产品</strong> 吗？</p>
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i> 此操作将从数据库中彻底删除数据，无法恢复。
                            如果产品已被订单引用，系统会自动将其设为下架状态而非删除。
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="deleteProductId" value="">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash-alt mr-1"></i> 确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量删除确认模态框 -->
    <div class="modal fade" id="batchDeleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="batchDeleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="batchDeleteConfirmModalLabel">批量删除确认</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p>您确定要永久删除选中的 <strong id="batchDeleteCount">0</strong> 个产品吗？</p>
                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-info-circle mr-1"></i> 此操作将从数据库中彻底删除数据，无法恢复。
                            已被订单引用的产品将会被设为下架状态而非删除。
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmBatchDeleteBtn">
                        <i class="fas fa-trash-alt mr-1"></i> 确认批量删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义JS -->
    <script>
        /**
         * 页面初始化
         */
        document.addEventListener('DOMContentLoaded', function() {
            window.initDependencies(function() {
                console.log('产品管理页面初始化');
                
                // 检查用户登录状态
                checkFarmerLogin();
                
                // 绑定图片预览事件
                $('#productImage').on('change', function() {
                    previewImage(this, '#imagePreview');
                });
                
                $('#editProductImage').on('change', function() {
                    previewImage(this, '#editImagePreview');
                });
                
                // 绑定表单提交事件
                $('#saveProductBtn').on('click', function() {
                    console.log('保存产品按钮被点击');
                    if (validateForm('add')) {
                        saveProduct();
                    }
                });
                
                $('#updateProductBtn').on('click', function() {
                    console.log('更新产品按钮被点击');
                    if (validateForm('edit')) {
                        updateProduct();
                    }
                });
                
                // 绑定删除确认按钮事件
                $('#confirmDeleteBtn').on('click', function() {
                    const productId = $('#deleteProductId').val();
                    if (productId) {
                        $('#deleteConfirmModal').modal('hide');
                        deleteProduct(productId);
                    }
                });
                
                // 绑定批量删除确认按钮事件
                $('#confirmBatchDeleteBtn').on('click', function() {
                    executeBatchDelete();
                });
                
                // 绑定筛选事件
                $('#statusFilter').on('change', filterProducts);
                $('#searchBtn').on('click', filterProducts);
                
                // 绑定搜索框回车事件
                $('#searchProduct').on('keypress', function(e) {
                    if (e.which === 13) { // 回车键的键值是13
                        e.preventDefault();
                        filterProducts();
                    }
                });
                
                // 加载产品列表
                loadProducts();
                
                // 使用事件委托绑定所有动态生成的产品操作按钮
                // 编辑按钮事件
                $(document).on('click', '.edit-btn', function() {
                    const productId = $(this).data('id');
                    console.log('编辑按钮被点击，产品ID:', productId);
                    openEditModal(productId);
                });
                
                // 删除按钮事件
                $(document).on('click', '.delete-btn', function() {
                    const productId = $(this).data('id');
                    console.log('删除按钮被点击，产品ID:', productId);
                    confirmDeleteProduct(productId);
                });
                
                // 详情按钮事件
                $(document).on('click', '.product-detail-btn', function() {
                    const productId = $(this).data('id');
                    console.log('详情按钮被点击，产品ID:', productId);
                    openProductDetailModal(productId);
                });
                
                // 批量管理功能事件绑定
                $('#batchManageBtn').on('click', function() {
                    toggleBatchMode(true);
                });
                
                $('#exitBatchBtn').on('click', function() {
                    toggleBatchMode(false);
                });
                
                // 全选/取消全选
                $('#selectAllProducts').on('change', function() {
                    const isChecked = $(this).prop('checked');
                    $('.product-checkbox').prop('checked', isChecked);
                });
                
                // 批量操作按钮事件
                $('#batchActiveBtn').on('click', function() {
                    batchUpdateStatus(true);
                });
                
                $('#batchInactiveBtn').on('click', function() {
                    batchUpdateStatus(false);
                });
                
                $('#batchDeleteBtn').on('click', function() {
                    batchDeleteProducts();
                });
                
                $('#batchExportBtn').on('click', function() {
                    batchExportProducts();
                });
                
                // 单个产品复选框点击事件 - 高亮选中行
                $(document).on('change', '.product-checkbox', function() {
                    const $row = $(this).closest('tr');
                    if ($(this).prop('checked')) {
                        $row.addClass('selected');
                    } else {
                        $row.removeClass('selected');
                        // 如果有取消选中的，则取消全选状态
                        $('#selectAllProducts').prop('checked', false);
                    }
                    
                    // 检查是否所有产品都被选中，如果是则将全选框也设置为选中状态
                    const totalCheckboxes = $('.product-checkbox').length;
                    const checkedCheckboxes = $('.product-checkbox:checked').length;
                    
                    if (totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes) {
                        $('#selectAllProducts').prop('checked', true);
                    }
                });
            });
        });
        
        /**
         * 预览图片
         */
        function previewImage(input, previewSelector) {
            console.log('预览图片，选择器:', previewSelector);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                console.log('预览图片文件:', file.name, '大小:', file.size, '类型:', file.type);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('图片读取完成，显示预览');
                    $(previewSelector).attr('src', e.target.result);
                }
                reader.readAsDataURL(file);
                $(input).next('.custom-file-label').text(file.name);
            } else {
                console.log('没有选择文件，或文件选择被取消');
            }
        }
        
        /**
         * 使用api.js中的checkLoginStatus检查登录，并进行额外的农户身份验证
         */
        function checkFarmerLogin() {
            try {
                // 获取token和用户信息
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                if (!token || !user || !user.userId) {
                    console.log('用户未登录，跳转到登录页面');
                    // 重定向到登录页
                    window.location.href = '../login.html?redirect=' + encodeURIComponent(window.location.href);
                    return false;
                }
                
                // 使用api.js中的checkLoginStatus检查登录状态
                if (!api.checkLoginStatus()) {
                    console.log('登录状态验证失败，跳转到登录页面');
                    return false;
                }
                
                // 再次检查农户身份
                if (user.role !== 'farmer') {
                    console.log('用户不是农户角色，跳转到首页');
                    alert('您需要以农户身份登录才能访问此页面');
                    window.location.href = '../../index.html';
                    return false;
                }
                
                // 显示用户信息
                $('#userDropdown').show();
                $('#loginItem, #registerItem').hide();
                $('#currentUsername').text(user.username || '农户用户');
                
                return true;
            } catch (error) {
                console.error('验证农户登录状态时发生错误:', error);
                alert('验证登录状态时发生错误，请重新登录');
                window.location.href = '../login.html?redirect=' + encodeURIComponent(window.location.href);
                return false;
            }
        }
        
        /**
         * 加载产品列表
         */
        async function loadProducts() {
            try {
                console.log('开始加载产品列表');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = user.userId;
                
                if (!userId) {
                    throw new Error('未找到用户ID');
                }
                
                console.log('当前用户ID:', userId);
                
                // 显示加载状态
                $('#productList').html('<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">加载中...</span></div></td></tr>');
                
                // 使用Axios获取农户产品，确保传递farmerId参数
                // 明确添加farmerId参数，确保只加载当前农户的产品
                const result = await http.get(`/product?farmerId=${userId}`);
                console.log('产品列表响应:', result);
                
                if (result && result.code === 200 && result.data) {
                    renderProductList(result.data);
                } else {
                    throw new Error(result.message || '获取产品列表失败');
                }
            } catch (error) {
                console.error('获取产品列表失败', error);
                alert('获取产品列表失败: ' + error.message);
                $('#productList').html('<tr><td colspan="7" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>');
            }
        }
        
        /**
         * 打开产品详情模态框并加载详情数据
         */
        async function openProductDetailModal(productId) {
            try {
                console.log('获取产品详情:', productId);
                
                // 显示加载状态
                $('#detailProductName').text('加载中...');
                $('#detailProductImage').attr('src', '../../img/loading.gif');
                $('#productDetailModal').modal('show');
                
                // 使用Axios获取产品详情
                const result = await http.get(`/product/${productId}`);
                
                if (result && result.code === 200 && result.data) {
                    const product = result.data;
                    console.log('获取到产品详情:', product);
                    
                    // 填充基本信息
                    $('#detailProductName').text(product.productName || '-');
                    $('#detailProductCategory').text(product.category || '未分类');
                    $('#detailProductPrice').text(`¥${product.price ? product.price.toFixed(2) : '0.00'}`);
                    $('#detailProductStock').text(`${product.stock || 0}`);
                    $('#detailDescription').text(product.description || '暂无描述');
                    $('#detailSpecification').text(product.specification || '-');
                    $('#detailIsOrganic').text(product.isOrganic ? '是' : '否');
                    
                    // 设置评分信息
                    $('#detailRating').text(product.averageRating ? product.averageRating.toFixed(1) : '-');
                    $('#detailReviewCount').text(product.reviewCount || 0);
                    
                    // 设置状态
                    const statusClass = product.isActive ? 'badge-success' : 'badge-secondary';
                    const statusText = product.isActive ? '上架' : '下架';
                    $('#detailProductStatus').removeClass('badge-success badge-secondary').addClass(statusClass).text(statusText);
                    
                    // 设置时间信息
                    $('#detailCreateTime').text(product.createTime ? new Date(product.createTime).toLocaleString() : '-');
                    $('#detailUpdateTime').text(product.updateTime ? new Date(product.updateTime).toLocaleString() : '-');
                    $('#detailActiveTime').text(product.activeTime ? new Date(product.activeTime).toLocaleString() : '-');
                    $('#detailInactiveTime').text(product.inactiveTime ? new Date(product.inactiveTime).toLocaleString() : '-');
                    
                    // 设置图片
                    if (product.imageUrl) {
                        // 确保图片路径正确
                        let imageUrl = product.imageUrl;
                        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                            imageUrl = '/' + imageUrl;
                        }
                        $('#detailProductImage').attr('src', imageUrl);
                    } else {
                        $('#detailProductImage').attr('src', '../../img/no-image.png');
                    }
                    
                    // 设置编辑按钮事件
                    $('.detail-edit-btn').off('click').on('click', function() {
                        $('#productDetailModal').modal('hide');
                        setTimeout(() => {
                            openEditModal(productId);
                        }, 500);
                    });
                    
                    // 设置删除按钮事件
                    $('.detail-delete-btn').off('click').on('click', function() {
                        $('#productDetailModal').modal('hide');
                        setTimeout(() => {
                            confirmDeleteProduct(productId);
                        }, 500);
                    });
                } else {
                    throw new Error(result.message || '获取产品详情失败');
                }
            } catch (error) {
                console.error('加载产品详情失败', error);
                $('#detailProductName').text('加载失败');
                $('#detailDescription').text(`错误: ${error.message}`);
            }
        }
        
        /**
         * 渲染产品列表
         */
        function renderProductList(products) {
            const $productList = $('#productList');
            $productList.empty();
            
            if (!products || products.length === 0) {
                // 显示空状态
                $('#emptyProducts').show();
                const colSpan = $('.batch-column').is(':visible') ? 7 : 6;
                $productList.append(`<tr><td colspan="${colSpan}" class="text-center">暂无产品数据</td></tr>`);
                return;
            }
            
            // 隐藏空状态
            $('#emptyProducts').hide();
            
            // 渲染产品列表
            products.forEach(function(product) {
                const statusClass = product.isActive ? 'badge-success' : 'badge-secondary';
                const statusText = product.isActive ? '上架' : '下架';
                
                // 确保图片路径正确
                let imageUrl = product.imageUrl;
                if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
                
                // 设置默认图片
                if (!imageUrl) {
                    imageUrl = '../../img/no-image.png';
                }
                
                // 格式化上架/下架时间显示
                let statusTimeInfo = '';
                let formattedTime = '';
                if (product.isActive && product.activeTime) {
                    const activeTime = new Date(product.activeTime);
                    statusTimeInfo = `上架时间: ${activeTime.toLocaleString()}`;
                    formattedTime = `<div class="small text-muted">${activeTime.toLocaleString()}</div>`;
                } else if (!product.isActive && product.inactiveTime) {
                    const inactiveTime = new Date(product.inactiveTime);
                    statusTimeInfo = `下架时间: ${inactiveTime.toLocaleString()}`;
                    formattedTime = `<div class="small text-muted">${inactiveTime.toLocaleString()}</div>`;
                }
                
                const row = `
                    <tr data-id="${product.productId}" 
                        data-status="${product.isActive ? 'active' : 'inactive'}"
                        data-active-time="${product.activeTime || ''}"
                        data-inactive-time="${product.inactiveTime || ''}"
                        data-create-time="${product.createTime || ''}"
                        data-update-time="${product.updateTime || ''}">
                        <td class="batch-column" style="display: none;">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input product-checkbox" id="product${product.productId}" data-id="${product.productId}">
                                <label class="custom-control-label" for="product${product.productId}"></label>
                            </div>
                        </td>
                        <td>
                            <img src="${imageUrl}" alt="${product.productName}" class="img-thumbnail" style="max-width: 80px; max-height: 80px;">
                        </td>
                        <td>${product.productName}</td>
                        <td>¥${product.price.toFixed(2)}</td>
                        <td>${product.stock} kg</td>
                        <td>
                            <span class="badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info product-detail-btn" data-id="${product.productId}" data-toggle="tooltip" title="查看详情"><i class="fa fa-info-circle"></i></button>
                            <button class="btn btn-sm btn-primary edit-btn" data-id="${product.productId}">编辑</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${product.productId}">删除</button>
                        </td>
                    </tr>
                `;
                
                $productList.append(row);
            });
            
            // 初始化工具提示
            $('[data-toggle="tooltip"]').tooltip();
        }
        
        /**
         * 打开编辑模态框并加载产品详情
         */
        async function openEditModal(productId) {
            try {
                console.log('获取产品详情:', productId);
                
                // 使用Axios获取产品详情
                const result = await http.get(`/product/${productId}`);
                
                if (result && result.code === 200 && result.data) {
                    const product = result.data;
                    console.log('获取到产品详情:', product);
                    
                    // 填充表单
                    $('#editProductId').val(product.productId);
                    $('#editProductName').val(product.productName);
                    $('#editProductPrice').val(product.price);
                    $('#editProductStock').val(product.stock);
                    $('#editProductDescription').val(product.description);
                    
                    // 设置产品分类
                    $('#editProductCategory').val(product.category || '其他');
                    
                    // 设置图片预览
                    if (product.imageUrl) {
                        // 确保图片路径正确
                        let imageUrl = product.imageUrl;
                        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                            imageUrl = '/' + imageUrl;
                        }
                        
                        console.log('设置编辑模式图片预览:', imageUrl);
                        $('#editImagePreview').attr('src', imageUrl);
                    } else {
                        $('#editImagePreview').attr('src', '../../img/no-image.png');
                    }
                    
                    // 显示模态框
                    $('#editProductModal').modal('show');
                } else {
                    throw new Error(result.message || '获取产品详情失败');
                }
            } catch (error) {
                console.error('加载产品详情失败', error);
                alert('加载产品详情失败: ' + error.message);
            }
        }
        
        /**
         * 确认删除产品
         */
        function confirmDeleteProduct(productId) {
            try {
                // 获取产品名称，用于显示在确认对话框中
                const productName = $(`tr[data-id="${productId}"]`).find('td:nth-child(3)').text();
                
                // 设置模态框中的产品ID和名称
                $('#deleteProductId').val(productId);
                $('#deleteProductName').text(productName || '此产品');
                
                // 显示删除确认模态框
                $('#deleteConfirmModal').modal('show');
            } catch (error) {
                console.error('打开删除确认对话框失败:', error);
                // 如果获取产品信息失败，仍然提供基本的确认对话框
                if (confirm('确定要永久删除这个产品吗？此操作将从数据库中彻底删除数据，无法恢复。')) {
                    deleteProduct(productId);
                }
            }
        }
        
        /**
         * 删除产品
         */
        async function deleteProduct(productId) {
            try {
                console.log('开始删除产品，ID:', productId);
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 准备删除请求数据，添加硬删除标记
                const deleteData = {
                    farmerId: parseInt(user.userId),
                    hardDelete: true  // 添加硬删除标记
                };
                
                console.log('删除请求数据:', deleteData);
                
                // 显示加载状态
                Swal.fire({
                    title: '正在删除',
                    text: '请稍候...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // 使用Axios删除产品
                const result = await http.delete(`/product/${productId}`, deleteData);
                console.log('删除产品响应:', result);
                
                if (result && result.code === 200) {
                    // 关闭加载中提示
                    Swal.close();
                    
                    // 根据后端返回的结果显示不同的提示信息
                    if (result.isHardDeleted) {
                        Swal.fire({
                            title: '删除成功',
                            text: '产品已永久删除',
                            icon: 'success',
                            confirmButtonText: '确定'
                        });
                    } else {
                        Swal.fire({
                            title: '部分成功',
                            text: '产品已被订单引用，已设置为下架状态但无法永久删除',
                            icon: 'info',
                            confirmButtonText: '确定'
                        });
                    }
                    
                    // 确保关闭任何可能打开的模态框
                    $('#productDetailModal').modal('hide');
                    $('#editProductModal').modal('hide');
                    
                    // 重新加载产品列表
                    await loadProducts();
                } else {
                    throw new Error(result.message || '删除产品失败');
                }
            } catch (error) {
                console.error('删除产品失败', error);
                
                // 更友好的错误提示
                let errorMessage = error.message;
                let iconType = 'error';
                
                if (errorMessage.includes('Network Error')) {
                    errorMessage = '网络错误，请检查您的网络连接';
                } else if (errorMessage.includes('timeout')) {
                    errorMessage = '请求超时，请稍后再试';
                } else if (errorMessage.includes('订单引用')) {
                    errorMessage = '该产品已被订单引用，无法永久删除，但已被设置为下架状态';
                    iconType = 'warning';
                } else if (errorMessage.includes('404') || errorMessage.includes('不存在')) {
                    errorMessage = '产品已被删除';
                    iconType = 'info';
                    // 尝试重新加载产品列表
                    await loadProducts();
                }
                
                Swal.fire({
                    title: '删除失败',
                    text: errorMessage,
                    icon: iconType,
                    confirmButtonText: '确定'
                });
            }
        }
        
        /**
         * 验证表单
         */
        function validateForm(formType) {
            console.log('验证表单，类型:', formType);
            
            if (formType === 'add') {
                // 获取表单字段
                const productName = $('#productName').val().trim();
                const productPrice = $('#productPrice').val();
                const productStock = $('#productStock').val();
                const productCategory = $('#productCategory').val();
                
                // 验证产品名称
                if (!productName) {
                    alert('请输入产品名称');
                    return false;
                }
                
                // 验证分类
                if (!productCategory) {
                    alert('请选择产品分类');
                    return false;
                }
                
                // 验证价格
                if (!productPrice || parseFloat(productPrice) <= 0) {
                    alert('请输入有效的价格');
                    return false;
                }
                
                // 验证库存
                if (!productStock || parseFloat(productStock) < 0) {
                    alert('请输入有效的库存数量');
                    return false;
                }
                
                // 验证图片（仅在添加时是必须的）
                if (!$('#productImage')[0].files[0]) {
                    alert('请上传产品图片');
                    return false;
                }
            } else if (formType === 'edit') {
                // 获取表单字段
                const productName = $('#editProductName').val().trim();
                const productPrice = $('#editProductPrice').val();
                const productStock = $('#editProductStock').val();
                const productCategory = $('#editProductCategory').val();
                
                // 验证产品名称
                if (!productName) {
                    alert('请输入产品名称');
                    return false;
                }
                
                // 验证分类
                if (!productCategory) {
                    alert('请选择产品分类');
                    return false;
                }
                
                // 验证价格
                if (!productPrice || parseFloat(productPrice) <= 0) {
                    alert('请输入有效的价格');
                    return false;
                }
                
                // 验证库存
                if (!productStock || parseFloat(productStock) < 0) {
                    alert('请输入有效的库存数量');
                    return false;
                }
            }
            
            return true;
        }
        
        /**
         * 上传产品图片
         */
        function uploadProductImage(file, callback) {
            // 验证文件类型
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                console.error('不支持的文件类型:', file.type);
                $('#uploadStatus, #editUploadStatus').text(`不支持的文件类型: ${file.type}，只支持JPG、PNG和GIF`).addClass('text-danger');
                throw new Error(`不支持的文件类型: ${file.type}，只支持JPG、PNG和GIF`);
            }
            
            // 确保文件大小合理
            if (file.size > 10 * 1024 * 1024) { // 10MB
                console.error('文件过大:', file.size);
                $('#uploadStatus, #editUploadStatus').text(`文件过大: ${Math.round(file.size/1024/1024)}MB，最大支持10MB`).addClass('text-danger');
                throw new Error(`文件过大，最大支持10MB`);
            }
            
            // 创建FormData对象用于文件上传
            const formData = new FormData();
            formData.append('file', file);
            
            console.log('开始上传图片:', file.name, '文件大小:', file.size, '文件类型:', file.type);
            
            // 显示上传状态
            $('#uploadStatus, #editUploadStatus').show().text('正在上传图片...').removeClass('text-danger text-success');
            
            // 使用 Axios 进行文件上传，这次不指定Content-Type，让浏览器自动处理
            return axios({
                method: 'post',
                url: http.defaults.baseURL + '/upload/single',
                data: formData,
                headers: {
                    'Authorization': 'Bearer ' + window.getToken()
                }
            })
            .then(response => {
                console.log('上传响应:', response);
                if (response && response.data && response.data.code === 200 && response.data.data) {
                    // 返回上传后的文件路径
                    const filePath = response.data.data.filePath;
                    console.log('上传成功，文件路径:', filePath);
                    $('#uploadStatus, #editUploadStatus').text('图片上传成功').removeClass('text-danger').addClass('text-success');
                    
                    // 确保路径正确处理
                    callback(filePath);
                    return filePath;
                } else {
                    console.error('上传响应格式不正确:', response);
                    $('#uploadStatus, #editUploadStatus').text('上传响应格式不正确').addClass('text-danger');
                    throw new Error('上传响应格式不正确');
                }
            })
            .catch(error => {
                console.error('上传图片失败', error);
                $('#uploadStatus, #editUploadStatus').text(`上传图片失败: ${error.message}`).addClass('text-danger');
                throw new Error('上传失败，请稍后重试');
            });
        }
        
        /**
         * 保存新产品
         */
        async function saveProduct() {
            try {
                console.log('开始保存产品');
                $('#saveProductBtn').attr('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...');
                
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 首先上传图片
                const imageFile = $('#productImage')[0].files[0];
                if (!imageFile) {
                    throw new Error('请选择产品图片');
                }
                
                console.log('准备上传图片:', imageFile.name);
                
                // 使用Promise方式处理图片上传
                const uploadImage = () => {
                    return new Promise((resolve, reject) => {
                        uploadProductImage(imageFile, (imageUrl) => {
                            console.log('图片上传成功，URL:', imageUrl);
                            resolve(imageUrl);
                        });
                    });
                };
                
                // 等待图片上传完成
                const imageUrl = await uploadImage();
                console.log('获取到图片URL:', imageUrl);
                
                // 收集产品数据
                const productData = {
                    farmerId: parseInt(user.userId),
                    productName: $('#productName').val().trim(),
                    description: $('#productDescription').val().trim() || '暂无描述',  // 确保描述不为空
                    price: parseFloat($('#productPrice').val()) || 0,  // 确保价格有效
                    stock: parseInt($('#productStock').val()) || 0,    // 确保库存为整数
                    imageUrl: imageUrl,
                    category: $('#productCategory').val() || '其他'
                };
                
                // 验证必填字段
                if (!productData.productName) {
                    throw new Error('产品名称不能为空');
                }
                
                if (productData.price <= 0) {
                    throw new Error('价格必须大于0');
                }
                
                if (productData.stock < 0) {
                    throw new Error('库存不能为负数');
                }
                
                console.log('提交产品数据:', productData);
                
                // 提交产品数据
                const result = await http.post('/product', productData);
                console.log('产品保存响应:', result);
                
                if (result && result.code === 200) {
                    alert('产品添加成功');
                    $('#addProductModal').modal('hide');
                    $('#addProductForm')[0].reset(); // 重置表单
                    $('#imagePreview').attr('src', '../../img/no-image.png'); // 重置图片预览
                    $('#uploadStatus').hide(); // 隐藏上传状态
                    loadProducts(); // 重新加载产品列表
                } else {
                    throw new Error(result.message || '添加产品失败');
                }
            } catch (error) {
                console.error('添加产品失败', error);
                alert('添加产品失败: ' + error.message);
            } finally {
                $('#saveProductBtn').attr('disabled', false).html('保存产品');
            }
        }
        
        /**
         * 更新产品
         */
        async function updateProduct() {
            try {
                console.log('开始更新产品');
                $('#updateProductBtn').attr('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...');
                
                const productId = $('#editProductId').val();
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 检查是否需要上传新图片
                const imageFile = $('#editProductImage')[0].files[0];
                let imageUrl = null;
                
                if (imageFile) {
                    // 使用Promise方式处理图片上传
                    const uploadImage = () => {
                        return new Promise((resolve, reject) => {
                            uploadProductImage(imageFile, (url) => {
                                console.log('编辑模式：图片上传成功，URL:', url);
                                resolve(url);
                            });
                        });
                    };
                    
                    // 显示状态
                    $('#editUploadStatus').show().text('正在上传图片...');
                    
                    // 等待图片上传完成
                    imageUrl = await uploadImage();
                }
                
                // 获取产品状态
                const isActive = $('#editProductStatus').val() === '上架';
                
                // 收集产品数据
                const productData = {
                    farmerId: parseInt(user.userId),
                    productName: $('#editProductName').val(),
                    description: $('#editProductDescription').val() || '',
                    price: parseFloat($('#editProductPrice').val()),
                    stock: parseFloat($('#editProductStock').val()),
                    category: $('#editProductCategory').val() || '其他',
                    isActive: isActive
                };
                
                // 如果有新图片URL，则更新
                if (imageUrl) {
                    productData.imageUrl = imageUrl;
                }
                
                console.log('更新产品数据:', productData);
                
                // 提交产品更新
                const result = await http.put(`/product/${productId}`, productData);
                
                console.log('产品更新响应:', result);
                
                if (result && result.code === 200) {
                    alert('产品更新成功');
                    $('#editProductModal').modal('hide');
                    $('#editUploadStatus').hide(); // 隐藏上传状态
                    loadProducts(); // 重新加载产品列表
                } else {
                    throw new Error(result.message || '更新产品失败');
                }
            } catch (error) {
                console.error('更新产品失败', error);
                alert('更新产品失败: ' + error.message);
            } finally {
                $('#updateProductBtn').attr('disabled', false).html('更新');
            }
        }
        
        /**
         * 切换批量管理模式
         */
        function toggleBatchMode(enable) {
            if (enable) {
                // 启用批量管理模式
                $('#batchToolbar').show();
                $('.batch-column').show();
                $('#batchManageBtn').hide();
            } else {
                // 关闭批量管理模式
                $('#batchToolbar').hide();
                $('.batch-column').hide();
                $('#batchManageBtn').show();
                
                // 取消所有选中的复选框
                $('#selectAllProducts').prop('checked', false);
                $('.product-checkbox').prop('checked', false);
            }
        }
        
        /**
         * 获取选中的产品ID列表
         */
        function getSelectedProductIds() {
            const selectedIds = [];
            $('.product-checkbox:checked').each(function() {
                selectedIds.push($(this).data('id'));
            });
            return selectedIds;
        }
        
        /**
         * 批量更新产品状态（上架/下架）
         */
        async function batchUpdateStatus(isActive) {
            try {
                const selectedIds = getSelectedProductIds();
                if (selectedIds.length === 0) {
                    Swal.fire({
                        title: '提示',
                        text: '请先选择要操作的产品',
                        icon: 'info',
                        confirmButtonText: '确定'
                    });
                    return;
                }
                
                // 使用SweetAlert2确认
                const result = await Swal.fire({
                    title: `确认批量${isActive ? '上架' : '下架'}`,
                    text: `确定要批量${isActive ? '上架' : '下架'}选中的 ${selectedIds.length} 个产品吗？`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `确认${isActive ? '上架' : '下架'}`,
                    cancelButtonText: '取消',
                    confirmButtonColor: isActive ? '#28a745' : '#6c757d'
                });
                
                if (!result.isConfirmed) {
                    return;
                }
                
                console.log(`开始批量${isActive ? '上架' : '下架'}产品，IDs:`, selectedIds);
                
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const currentTime = new Date().toISOString();
                
                // 显示进度条
                const $progressContainer = $('<div class="progress mt-2 mb-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>');
                const $progressStatus = $('<div class="small text-center mb-2">正在处理：0/' + selectedIds.length + '</div>');
                
                Swal.fire({
                    title: `正在${isActive ? '上架' : '下架'}产品`,
                    html: $progressContainer[0].outerHTML + $progressStatus[0].outerHTML,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
            
                // 逐个更新产品状态
                let successCount = 0;
                let errors = [];
                
                for (let i = 0; i < selectedIds.length; i++) {
                    try {
                        const productId = selectedIds[i];
                        
                        // 更新进度
                        const percent = Math.round(((i) / selectedIds.length) * 100);
                        $('.progress-bar').css('width', percent + '%').attr('aria-valuenow', percent);
                        $('.small.text-center').text('正在处理：' + (i + 1) + '/' + selectedIds.length);
                        
                        // 使用现有的API更新产品状态
                        const updateData = {
                            farmerId: parseInt(user.userId),
                            isActive: isActive
                        };
                        
                        // 添加上下架时间
                        if (isActive) {
                            updateData.activeTime = currentTime;
                        } else {
                            updateData.inactiveTime = currentTime;
                        }
                        
                        const response = await http.put(`/product/${productId}`, updateData);
                        
                        if (response && response.code === 200) {
                            successCount++;
                            
                            // 更新页面上的产品状态
                            const $row = $(`tr[data-id="${productId}"]`);
                            const statusClass = isActive ? 'badge-success' : 'badge-secondary';
                            const statusText = isActive ? '上架' : '下架';
                            const formattedTime = new Date(currentTime).toLocaleString();
                            
                            $row.attr('data-status', isActive ? 'active' : 'inactive');
                            $row.find('td:nth-child(6) .badge')
                                .removeClass('badge-success badge-secondary')
                                .addClass(statusClass)
                                .text(statusText);
                                
                            // 更新时间显示
                            $row.find('td:nth-child(6) .small')
                                .text(formattedTime);
                        } else {
                            throw new Error(response.message || `更新产品${productId}失败`);
                        }
                    } catch (error) {
                        console.error(`更新产品${selectedIds[i]}失败:`, error);
                        errors.push(`产品ID ${selectedIds[i]}: ${error.message}`);
                    }
                }
                
                // 关闭进度对话框
                Swal.close();
                
                // 显示操作结果
                if (errors.length > 0) {
                    let resultMessage = `<div class="text-left">批量${isActive ? '上架' : '下架'}完成：</div>
                        <ul class="text-left my-2">
                            <li><span class="text-success">成功: ${successCount} 个产品</span></li>
                            <li><span class="text-danger">失败: ${errors.length} 个产品</span></li>
                        </ul>`;
                        
                    if (errors.length > 0) {
                        resultMessage += `<div class="mt-2 text-left"><strong>失败原因:</strong></div>
                            <div class="small text-left text-danger mt-1" style="max-height: 150px; overflow-y: auto;">
                                ${errors.join('<br>')}
                            </div>`;
                    }
                    
                    Swal.fire({
                        title: `批量${isActive ? '上架' : '下架'}结果`,
                        icon: 'warning',
                        html: resultMessage,
                        confirmButtonText: '确定'
                    });
                } else {
                    Swal.fire({
                        title: '操作成功',
                        text: `成功批量${isActive ? '上架' : '下架'} ${successCount} 个产品`,
                        icon: 'success',
                        confirmButtonText: '确定'
                    });
                }
            } catch (error) {
                console.error(`批量${isActive ? '上架' : '下架'}失败:`, error);
                Swal.fire({
                    title: '操作失败',
                    text: `批量${isActive ? '上架' : '下架'}失败: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: '确定'
                });
            }
        }
        
        /**
         * 批量删除产品
         */
        async function batchDeleteProducts() {
            try {
                const selectedIds = getSelectedProductIds();
                if (selectedIds.length === 0) {
                    alert('请先选择要删除的产品');
                    return;
                }
                
                // 设置批量删除数量并显示确认模态框
                $('#batchDeleteCount').text(selectedIds.length);
                $('#batchDeleteConfirmModal').modal('show');
            } catch (error) {
                console.error('批量删除失败:', error);
                alert('批量删除操作失败: ' + error.message);
            }
        }
        
        /**
         * 执行批量删除
         */
        async function executeBatchDelete() {
            try {
                const selectedIds = getSelectedProductIds();
                if (selectedIds.length === 0) {
                    return;
                }
                
                // 关闭所有可能打开的模态框，避免删除后出现404错误
                $('#productDetailModal').modal('hide');
                $('#editProductModal').modal('hide');
                $('#batchDeleteConfirmModal').modal('hide');
                
                console.log('开始批量删除产品，IDs:', selectedIds);
                
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 跟踪删除结果
                let hardDeletedCount = 0;  // 硬删除成功数量
                let softDeletedCount = 0;  // 软删除成功数量
                let failedCount = 0;       // 失败数量
                let errors = [];           // 错误信息
                
                // 准备删除请求数据，添加硬删除标记
                const deleteData = {
                    farmerId: parseInt(user.userId),
                    hardDelete: true  // 添加硬删除标记
                };
                
                // 显示进度条或加载指示器
                const $progressContainer = $('<div class="progress mt-2 mb-2"><div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>');
                const $progressStatus = $('<div class="small text-center mb-2">正在处理：0/' + selectedIds.length + '</div>');
                
                // 使用sweetalert2显示进度
                Swal.fire({
                    title: '正在删除产品',
                    html: $progressContainer[0].outerHTML + $progressStatus[0].outerHTML,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                for (let i = 0; i < selectedIds.length; i++) {
                    const productId = selectedIds[i];
                    try {
                        // 更新进度
                        const percent = Math.round((i / selectedIds.length) * 100);
                        $('.progress-bar').css('width', percent + '%').attr('aria-valuenow', percent);
                        $('.small.text-center').text('正在处理：' + (i + 1) + '/' + selectedIds.length);
                        
                        // 使用现有的API删除产品
                        const response = await http.delete(`/product/${productId}`, deleteData);
                        
                        if (response && response.code === 200) {
                            // 根据后端返回的结果区分硬删除和软删除
                            if (response.isHardDeleted) {
                                hardDeletedCount++;
                                // 从页面上移除产品行
                                $(`tr[data-id="${productId}"]`).fadeOut(300, function() {
                                    $(this).remove();
                                });
                            } else {
                                softDeletedCount++;
                                // 更新产品行状态为下架
                                const $row = $(`tr[data-id="${productId}"]`);
                                $row.attr('data-status', 'inactive');
                                $row.find('td:nth-child(6) .badge')
                                    .removeClass('badge-success')
                                    .addClass('badge-secondary')
                                    .text('下架');
                            }
                        } else {
                            failedCount++;
                            throw new Error(response.message || `删除产品${productId}失败`);
                        }
                    } catch (error) {
                        failedCount++;
                        console.error(`删除产品${productId}失败:`, error);
                        
                        // 更友好地处理404错误
                        let errorMessage = error.message;
                        if (errorMessage.includes('404') || errorMessage.includes('不存在')) {
                            // 产品可能已被删除，从DOM中移除对应行
                            $(`tr[data-id="${productId}"]`).fadeOut(300, function() {
                                $(this).remove();
                            });
                            errorMessage = `产品ID ${productId}: 产品不存在或已被删除`;
                        } else {
                            errorMessage = `产品ID ${productId}: ${error.message}`;
                        }
                        
                        errors.push(errorMessage);
                    }
                }
                
                // 关闭进度对话框
                Swal.close();
                
                // 构建操作结果消息
                let resultMessage = `<div class="text-left">批量删除操作完成：</div><ul class="text-left mt-2 mb-0">`;
                if (hardDeletedCount > 0) {
                    resultMessage += `<li><span class="text-success">${hardDeletedCount} 个产品已永久删除</span></li>`;
                }
                if (softDeletedCount > 0) {
                    resultMessage += `<li><span class="text-warning">${softDeletedCount} 个产品因被订单引用而仅设置为下架状态</span></li>`;
                }
                if (failedCount > 0) {
                    resultMessage += `<li><span class="text-danger">${failedCount} 个产品删除失败</span></li>`;
                }
                resultMessage += `</ul>`;
                
                if (failedCount > 0 && errors.length > 0) {
                    resultMessage += `<div class="mt-2 text-left"><strong>失败原因:</strong></div><div class="small text-left text-danger mt-1" style="max-height: 150px; overflow-y: auto;">`;
                    errors.forEach(err => {
                        resultMessage += `${err}<br>`;
                    });
                    resultMessage += `</div>`;
                }
                
                // 使用SweetAlert2显示结果
                Swal.fire({
                    title: '批量删除结果',
                    icon: failedCount > 0 ? 'warning' : 'success',
                    html: resultMessage,
                    confirmButtonText: '确定'
                });
            
                // 如果有产品已删除/更新，重新加载产品列表
                if (hardDeletedCount > 0 || softDeletedCount > 0) {
                    // 完全重新加载产品列表，确保UI状态一致
                    loadProducts();
                }
            } catch (error) {
                console.error('批量删除失败:', error);
                Swal.fire({
                    title: '操作失败',
                    text: '批量删除操作失败: ' + error.message,
                    icon: 'error',
                    confirmButtonText: '确定'
                });
            }
        }
        
        /**
         * 批量导出产品数据
         */
        function batchExportProducts() {
            try {
                const selectedIds = getSelectedProductIds();
                if (selectedIds.length === 0) {
                    alert('请先选择要导出的产品');
                    return;
                }
                
                console.log('准备导出产品，IDs:', selectedIds);
                
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 构建导出URL
                const exportUrl = `${http.defaults.baseURL}/product/export?farmerId=${user.userId}`;
                
                // 在新窗口或标签页中打开导出URL
                window.open(exportUrl, '_blank');
                
                alert(`已开始导出 ${selectedIds.length} 个产品的数据，如果文件没有自动下载，请检查浏览器是否阻止了弹出窗口。`);
            } catch (error) {
                console.error('批量导出失败:', error);
                alert('批量导出失败: ' + error.message);
                }
        }
        
        /**
         * 筛选产品列表
         */
        function filterProducts() {
            const statusFilter = $('#statusFilter').val();
            const searchText = $('#searchProduct').val().toLowerCase().trim();
            
            console.log(`筛选产品 - 状态: ${statusFilter}, 搜索: ${searchText}`);
            
            // 遍历所有产品行
            $('#productList tr').each(function() {
                const $row = $(this);
                const productId = $row.data('id');
                
                // 跳过非产品行（如加载提示行）
                if (!productId) {
                    return;
                }
                
                // 获取产品状态和名称
                const status = $row.data('status'); // active 或 inactive
                const productName = $row.find('td:nth-child(3)').text().toLowerCase();
                
                // 状态筛选条件
                let matchStatus = true;
                if (statusFilter === 'active') {
                    matchStatus = (status === 'active');
                } else if (statusFilter === 'inactive') {
                    matchStatus = (status === 'inactive');
                }
                
                // 名称搜索条件
                let matchName = true;
                if (searchText) {
                    matchName = productName.includes(searchText);
                }
                
                // 同时满足状态和名称条件才显示
                if (matchStatus && matchName) {
                    $row.show();
                } else {
                    $row.hide();
                }
            });
            
            // 检查是否所有行都被隐藏
            const visibleRows = $('#productList tr:visible').length;
            const colSpan = $('.batch-column').is(':visible') ? 7 : 6;
            
            // 如果没有可见行，显示空提示
            if (visibleRows === 0) {
                // 移除可能存在的空提示行
                $('#productList .empty-filter-result').remove();
                // 添加空提示行
                $('#productList').append(`
                    <tr class="empty-filter-result">
                        <td colspan="${colSpan}" class="text-center py-3">
                            <i class="fas fa-filter mr-2"></i> 没有符合筛选条件的商品
                        </td>
                    </tr>
                `);
                // 隐藏空状态提示
                $('#emptyProducts').hide();
            } else {
                // 移除可能存在的空提示行
                $('#productList .empty-filter-result').remove();
                }
        }
        
        /**
         * 处理产品上下架状态变更
         */
        async function handleProductStatus(productId, makeActive) {
            try {
                console.log(`开始${makeActive ? '上架' : '下架'}产品，ID:`, productId);
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 准备更新状态的请求数据
                const updateData = {
                    farmerId: parseInt(user.userId),
                    isActive: makeActive,
                };
                
                // 添加时间字段
                if (makeActive) {
                    updateData.activeTime = new Date().toISOString();
                } else {
                    updateData.inactiveTime = new Date().toISOString();
                }
                
                console.log('状态更新请求数据:', updateData);
                
                // 使用Axios更新产品状态
                const result = await http.put(`/product/${productId}`, updateData);
                console.log('更新产品状态响应:', result);
                
                if (result && result.code === 200) {
                    alert(`产品${makeActive ? '上架' : '下架'}成功`);
                    await loadProducts(); // 重新加载产品列表
                } else {
                    throw new Error(result.message || `产品${makeActive ? '上架' : '下架'}失败`);
                }
            } catch (error) {
                console.error(`产品${makeActive ? '上架' : '下架'}失败`, error);
                alert(`产品${makeActive ? '上架' : '下架'}失败: ` + error.message);
            }
        }
    </script>
</body>
</html> 