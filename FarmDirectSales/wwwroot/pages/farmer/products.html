<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品管理 - 农产品直销平台</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../../js/dependencies.js"></script>
    <!-- 引入Axios库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- API调用相关 -->
    <script src="../../js/api.js"></script>
    <!-- Axios配置 -->
    <script src="../../js/axios-config.js"></script>
    <script src="../../js/auth.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">农户中心</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">农户首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">我的产品</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">订单管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="batch-products.html">批量管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">销售统计</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                            <span id="currentUsername">用户</span>
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="farm-profile.html">农场资料</a>
                            <a class="dropdown-item active" href="products.html">我的产品</a>
                            <a class="dropdown-item" href="batch-products.html">批量管理</a>
                            <a class="dropdown-item" href="orders.html">订单管理</a>
                            <a class="dropdown-item" href="statistics.html">销售统计</a>
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="../../index.html">返回网站首页</a>
                            <a class="dropdown-item" href="#" id="logoutBtn">退出登录</a>
                        </div>
                    </li>
                    <li class="nav-item" id="loginItem">
                        <a class="nav-link" href="../login.html">登录</a>
                    </li>
                    <li class="nav-item" id="registerItem">
                        <a class="nav-link" href="../register.html">注册</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container my-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="dashboard.html" class="list-group-item list-group-item-action">农户首页</a>
                    <a href="farm-profile.html" class="list-group-item list-group-item-action">农场资料</a>
                    <a href="products.html" class="list-group-item list-group-item-action active">我的产品</a>
                    <a href="batch-products.html" class="list-group-item list-group-item-action">批量管理</a>
                    <a href="orders.html" class="list-group-item list-group-item-action">订单管理</a>
                    <a href="statistics.html" class="list-group-item list-group-item-action">销售统计</a>
                    <a href="profile.html" class="list-group-item list-group-item-action">个人信息</a>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="col-md-9">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">我的产品</h4>
                        <button class="btn btn-light" data-toggle="modal" data-target="#addProductModal">
                            <i class="fa fa-plus"></i> 添加产品
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 产品列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>产品图片</th>
                                        <th>名称</th>
                                        <th>价格(元/kg)</th>
                                        <th>库存(kg)</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="productList">
                                    <!-- 产品列表将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="6" class="text-center">正在加载产品...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 空状态提示 -->
                        <div id="emptyProducts" class="text-center py-5" style="display: none;">
                            <img src="../../img/empty-box.png" alt="暂无产品" class="img-fluid mb-3" style="max-width: 120px;">
                            <h5 class="text-muted">您还没有添加任何产品</h5>
                            <p class="text-muted">点击"添加产品"按钮开始添加您的第一个产品</p>
                            <button class="btn btn-primary" data-toggle="modal" data-target="#addProductModal">
                                添加产品
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加产品模态框 -->
    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addProductModalLabel">添加新产品</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="productName">产品名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="productCategory">产品类别 <span class="text-danger">*</span></label>
                                <select class="form-control" id="productCategory" required>
                                    <option value="">请选择类别</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="水果">水果</option>
                                    <option value="谷物">谷物</option>
                                    <option value="肉类">肉类</option>
                                    <option value="奶制品">奶制品</option>
                                    <option value="蛋类">蛋类</option>
                                    <option value="水产品">水产品</option>
                                    <option value="干货">干货</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="productPrice">价格(元/kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" min="0.01" step="0.01" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="productStock">库存(kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productStock" min="0" step="0.1" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">产品描述</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="productSpecification">规格说明</label>
                            <input type="text" class="form-control" id="productSpecification" placeholder="如：5kg/箱">
                        </div>
                        
                        <div class="form-group">
                            <label>产品图片 <span class="text-danger">*</span></label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="productImage" accept="image/*" required>
                                <label class="custom-file-label" for="productImage">选择文件</label>
                            </div>
                            <div class="mt-2">
                                <img id="imagePreview" src="../../img/no-image.png" alt="产品图片预览" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            <!-- 添加上传状态显示 -->
                            <div id="uploadStatus" class="mt-2 small" style="display: none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="isOrganic">
                                <label class="custom-control-label" for="isOrganic">有机认证</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="harvestDate">收获日期</label>
                            <input type="date" class="form-control" id="harvestDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="shelfLife">保质期(天)</label>
                            <input type="number" class="form-control" id="shelfLife" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="productStatus">状态</label>
                            <select class="form-control" id="productStatus">
                                <option value="上架">上架</option>
                                <option value="下架">下架</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">保存产品</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑产品模态框 -->
    <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProductModalLabel">编辑产品</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editProductName">产品名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editProductName" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editProductCategory">产品类别 <span class="text-danger">*</span></label>
                                <select class="form-control" id="editProductCategory" required>
                                    <option value="">请选择类别</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="水果">水果</option>
                                    <option value="谷物">谷物</option>
                                    <option value="肉类">肉类</option>
                                    <option value="奶制品">奶制品</option>
                                    <option value="蛋类">蛋类</option>
                                    <option value="水产品">水产品</option>
                                    <option value="干货">干货</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editProductPrice">价格(元/kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editProductPrice" min="0.01" step="0.01" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editProductStock">库存(kg) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editProductStock" min="0" step="0.1" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductDescription">产品描述</label>
                            <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductSpecification">规格说明</label>
                            <input type="text" class="form-control" id="editProductSpecification" placeholder="如：5kg/箱">
                        </div>
                        
                        <div class="form-group">
                            <label>产品图片</label>
                            <div class="mb-2">
                                <img id="editImagePreview" src="../../img/no-image.png" alt="产品图片预览" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="editProductImage" accept="image/*">
                                <label class="custom-file-label" for="editProductImage">选择新图片</label>
                            </div>
                            <small class="form-text text-muted">如不需更换图片请勿上传</small>
                            <div class="mt-2">
                                <img id="editImagePreview" src="../../img/no-image.png" alt="产品图片预览" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                            <div id="editUploadStatus" class="mt-2 small" style="display: none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="editIsOrganic">
                                <label class="custom-control-label" for="editIsOrganic">有机认证</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editHarvestDate">收获日期</label>
                            <input type="date" class="form-control" id="editHarvestDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="editShelfLife">保质期(天)</label>
                            <input type="number" class="form-control" id="editShelfLife" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductStatus">状态</label>
                            <select class="form-control" id="editProductStatus">
                                <option value="上架">上架</option>
                                <option value="下架">下架</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="updateProductBtn">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p>© 2023 农产品直销平台 版权所有</p>
        </div>
    </footer>

    <!-- 自定义JS -->
    <script>
        /**
         * 页面初始化
         */
        document.addEventListener('DOMContentLoaded', function() {
            window.initDependencies(function() {
                console.log('产品管理页面初始化');
                
                // 检查用户登录状态
                checkFarmerLogin();
                
                // 绑定图片预览事件
                $('#productImage').on('change', function() {
                    previewImage(this, '#imagePreview');
                });
                
                $('#editProductImage').on('change', function() {
                    previewImage(this, '#editImagePreview');
                });
                
                // 绑定表单提交事件
                $('#saveProductBtn').on('click', function() {
                    console.log('保存产品按钮被点击');
                    if (validateForm('add')) {
                        saveProduct();
                    }
                });
                
                $('#updateProductBtn').on('click', function() {
                    console.log('更新产品按钮被点击');
                    if (validateForm('edit')) {
                        updateProduct();
                    }
                });
                
                // 加载产品列表
                loadProducts();
                
                // 动态绑定产品操作按钮事件
                $(document).on('click', '.edit-btn', function() {
                    const productId = $(this).data('id');
                    console.log('编辑按钮被点击，产品ID:', productId);
                    openEditModal(productId);
                });
                
                $(document).on('click', '.delete-btn', function() {
                    const productId = $(this).data('id');
                    console.log('删除按钮被点击，产品ID:', productId);
                    confirmDeleteProduct(productId);
                });
            });
        });
        
        /**
         * 预览图片
         */
        function previewImage(input, previewSelector) {
            console.log('预览图片，选择器:', previewSelector);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                console.log('预览图片文件:', file.name, '大小:', file.size, '类型:', file.type);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('图片读取完成，显示预览');
                    $(previewSelector).attr('src', e.target.result);
                }
                reader.readAsDataURL(file);
                $(input).next('.custom-file-label').text(file.name);
            } else {
                console.log('没有选择文件，或文件选择被取消');
            }
        }
        
        /**
         * 使用api.js中的checkLoginStatus检查登录，并进行额外的农户身份验证
         */
        function checkFarmerLogin() {
            try {
                // 获取token和用户信息
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                if (!token || !user || !user.userId) {
                    console.log('用户未登录，跳转到登录页面');
                    // 重定向到登录页
                    window.location.href = '../login.html?redirect=' + encodeURIComponent(window.location.href);
                    return false;
                }
                
                // 使用api.js中的checkLoginStatus检查登录状态
                if (!api.checkLoginStatus()) {
                    console.log('登录状态验证失败，跳转到登录页面');
                    return false;
                }
                
                // 再次检查农户身份
                if (user.role !== 'farmer') {
                    console.log('用户不是农户角色，跳转到首页');
                    alert('您需要以农户身份登录才能访问此页面');
                    window.location.href = '../../index.html';
                    return false;
                }
                
                // 显示用户信息
                $('#userDropdown').show();
                $('#loginItem, #registerItem').hide();
                $('#currentUsername').text(user.username || '农户用户');
                
                return true;
            } catch (error) {
                console.error('验证农户登录状态时发生错误:', error);
                alert('验证登录状态时发生错误，请重新登录');
                window.location.href = '../login.html?redirect=' + encodeURIComponent(window.location.href);
                return false;
            }
        }
        
        /**
         * 加载产品列表
         */
        async function loadProducts() {
            try {
                console.log('开始加载产品列表');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = user.userId;
                
                if (!userId) {
                    throw new Error('未找到用户ID');
                }
                
                console.log('当前用户ID:', userId);
                
                // 显示加载状态
                $('#productList').html('<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">加载中...</span></div></td></tr>');
                
                // 使用Axios获取农户产品，确保传递farmerId参数
                // 明确添加farmerId参数，确保只加载当前农户的产品
                const result = await http.get(`/product?farmerId=${userId}`);
                console.log('产品列表响应:', result);
                
                if (result && result.code === 200 && result.data) {
                    renderProductList(result.data);
                } else {
                    throw new Error(result.message || '获取产品列表失败');
                }
            } catch (error) {
                console.error('获取产品列表失败', error);
                alert('获取产品列表失败: ' + error.message);
                $('#productList').html('<tr><td colspan="6" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>');
            }
        }
        
        /**
         * 渲染产品列表
         */
        function renderProductList(products) {
            const $productList = $('#productList');
            $productList.empty();
            
            if (!products || products.length === 0) {
                // 显示空状态
                $('#emptyProducts').show();
                $productList.append('<tr><td colspan="6" class="text-center">暂无产品数据</td></tr>');
                return;
            }
            
            // 隐藏空状态
            $('#emptyProducts').hide();
            
            // 渲染产品列表
            products.forEach(function(product) {
                const statusClass = product.isActive ? 'badge-success' : 'badge-secondary';
                const statusText = product.isActive ? '上架' : '下架';
                
                // 确保图片路径正确
                let imageUrl = product.imageUrl;
                if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
                
                // 设置默认图片
                if (!imageUrl) {
                    imageUrl = '../../img/no-image.png';
                }
                
                const row = `
                    <tr data-id="${product.productId}">
                        <td>
                            <img src="${imageUrl}" alt="${product.productName}" class="img-thumbnail" style="max-width: 80px; max-height: 80px;">
                        </td>
                        <td>${product.productName}</td>
                        <td>¥${product.price.toFixed(2)}</td>
                        <td>${product.stock} kg</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-btn" data-id="${product.productId}">编辑</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${product.productId}">删除</button>
                        </td>
                    </tr>
                `;
                
                $productList.append(row);
            });
            
            // 绑定编辑和删除事件
            $('.edit-btn').on('click', function() {
                const productId = $(this).data('id');
                openEditModal(productId);
            });
            
            $('.delete-btn').on('click', function() {
                const productId = $(this).data('id');
                confirmDeleteProduct(productId);
            });
        }
        
        /**
         * 打开编辑模态框并加载产品详情
         */
        async function openEditModal(productId) {
            try {
                console.log('获取产品详情:', productId);
                
                // 使用Axios获取产品详情
                const result = await http.get(`/product/${productId}`);
                
                if (result && result.code === 200 && result.data) {
                    const product = result.data;
                    console.log('获取到产品详情:', product);
                    
                    // 填充表单
                    $('#editProductId').val(product.productId);
                    $('#editProductName').val(product.productName);
                    $('#editProductPrice').val(product.price);
                    $('#editProductStock').val(product.stock);
                    $('#editProductDescription').val(product.description);
                    
                    // 设置产品分类
                    $('#editProductCategory').val(product.category || '其他');
                    
                    // 设置图片预览
                    if (product.imageUrl) {
                        // 确保图片路径正确
                        let imageUrl = product.imageUrl;
                        if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                            imageUrl = '/' + imageUrl;
                        }
                        
                        console.log('设置编辑模式图片预览:', imageUrl);
                        $('#editImagePreview').attr('src', imageUrl);
                    } else {
                        $('#editImagePreview').attr('src', '../../img/no-image.png');
                    }
                    
                    // 显示模态框
                    $('#editProductModal').modal('show');
                } else {
                    throw new Error(result.message || '获取产品详情失败');
                }
            } catch (error) {
                console.error('加载产品详情失败', error);
                alert('加载产品详情失败: ' + error.message);
            }
        }
        
        /**
         * 确认删除产品
         */
        function confirmDeleteProduct(productId) {
            if (confirm('确定要删除这个产品吗？此操作无法撤销。')) {
                deleteProduct(productId);
            }
        }
        
        /**
         * 删除产品
         */
        async function deleteProduct(productId) {
            try {
                console.log('开始删除产品，ID:', productId);
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 准备删除请求数据
                const deleteData = {
                    farmerId: parseInt(user.userId)
                };
                
                console.log('删除请求数据:', deleteData);
                
                // 使用Axios删除产品
                const result = await http.delete(`/product/${productId}`, deleteData);
                console.log('删除产品响应:', result);
                
                if (result && result.code === 200) {
                    alert('产品删除成功');
                    await loadProducts(); // 重新加载产品列表
                } else {
                    throw new Error(result.message || '删除产品失败');
                }
            } catch (error) {
                console.error('删除产品失败', error);
                alert('删除产品失败: ' + error.message);
            }
        }
        
        /**
         * 验证表单
         */
        function validateForm(formType) {
            console.log('验证表单，类型:', formType);
            
            if (formType === 'add') {
                // 获取表单字段
                const productName = $('#productName').val().trim();
                const productPrice = $('#productPrice').val();
                const productStock = $('#productStock').val();
                const productCategory = $('#productCategory').val();
                
                // 验证产品名称
                if (!productName) {
                    alert('请输入产品名称');
                    return false;
                }
                
                // 验证分类
                if (!productCategory) {
                    alert('请选择产品分类');
                    return false;
                }
                
                // 验证价格
                if (!productPrice || parseFloat(productPrice) <= 0) {
                    alert('请输入有效的价格');
                    return false;
                }
                
                // 验证库存
                if (!productStock || parseFloat(productStock) < 0) {
                    alert('请输入有效的库存数量');
                    return false;
                }
                
                // 验证图片（仅在添加时是必须的）
                if (!$('#productImage')[0].files[0]) {
                    alert('请上传产品图片');
                    return false;
                }
            } else if (formType === 'edit') {
                // 获取表单字段
                const productName = $('#editProductName').val().trim();
                const productPrice = $('#editProductPrice').val();
                const productStock = $('#editProductStock').val();
                const productCategory = $('#editProductCategory').val();
                
                // 验证产品名称
                if (!productName) {
                    alert('请输入产品名称');
                    return false;
                }
                
                // 验证分类
                if (!productCategory) {
                    alert('请选择产品分类');
                    return false;
                }
                
                // 验证价格
                if (!productPrice || parseFloat(productPrice) <= 0) {
                    alert('请输入有效的价格');
                    return false;
                }
                
                // 验证库存
                if (!productStock || parseFloat(productStock) < 0) {
                    alert('请输入有效的库存数量');
                    return false;
                }
            }
            
            return true;
        }
        
        /**
         * 上传产品图片
         */
        function uploadProductImage(file, callback) {
            // 验证文件类型
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                console.error('不支持的文件类型:', file.type);
                $('#uploadStatus, #editUploadStatus').text(`不支持的文件类型: ${file.type}，只支持JPG、PNG和GIF`).addClass('text-danger');
                throw new Error(`不支持的文件类型: ${file.type}，只支持JPG、PNG和GIF`);
            }
            
            // 确保文件大小合理
            if (file.size > 10 * 1024 * 1024) { // 10MB
                console.error('文件过大:', file.size);
                $('#uploadStatus, #editUploadStatus').text(`文件过大: ${Math.round(file.size/1024/1024)}MB，最大支持10MB`).addClass('text-danger');
                throw new Error(`文件过大，最大支持10MB`);
            }
            
            // 创建FormData对象用于文件上传
            const formData = new FormData();
            formData.append('file', file);
            
            console.log('开始上传图片:', file.name, '文件大小:', file.size, '文件类型:', file.type);
            
            // 显示上传状态
            $('#uploadStatus, #editUploadStatus').show().text('正在上传图片...').removeClass('text-danger text-success');
            
            // 使用 Axios 进行文件上传，这次不指定Content-Type，让浏览器自动处理
            return axios({
                method: 'post',
                url: http.defaults.baseURL + '/upload/single',
                data: formData,
                headers: {
                    'Authorization': 'Bearer ' + window.getToken()
                }
            })
            .then(response => {
                console.log('上传响应:', response);
                if (response && response.data && response.data.code === 200 && response.data.data) {
                    // 返回上传后的文件路径
                    const filePath = response.data.data.filePath;
                    console.log('上传成功，文件路径:', filePath);
                    $('#uploadStatus, #editUploadStatus').text('图片上传成功').removeClass('text-danger').addClass('text-success');
                    
                    // 确保路径正确处理
                    callback(filePath);
                    return filePath;
                } else {
                    console.error('上传响应格式不正确:', response);
                    $('#uploadStatus, #editUploadStatus').text('上传响应格式不正确').addClass('text-danger');
                    throw new Error('上传响应格式不正确');
                }
            })
            .catch(error => {
                console.error('上传图片失败', error);
                $('#uploadStatus, #editUploadStatus').text(`上传图片失败: ${error.message}`).addClass('text-danger');
                throw new Error('上传失败，请稍后重试');
            });
        }
        
        /**
         * 保存新产品
         */
        async function saveProduct() {
            try {
                console.log('开始保存产品');
                $('#saveProductBtn').attr('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...');
                
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 首先上传图片
                const imageFile = $('#productImage')[0].files[0];
                if (!imageFile) {
                    throw new Error('请选择产品图片');
                }
                
                console.log('准备上传图片:', imageFile.name);
                
                // 使用Promise方式处理图片上传
                const uploadImage = () => {
                    return new Promise((resolve, reject) => {
                        uploadProductImage(imageFile, (imageUrl) => {
                            console.log('图片上传成功，URL:', imageUrl);
                            resolve(imageUrl);
                        });
                    });
                };
                
                // 等待图片上传完成
                const imageUrl = await uploadImage();
                console.log('获取到图片URL:', imageUrl);
                
                // 收集产品数据
                const productData = {
                    farmerId: parseInt(user.userId),
                    productName: $('#productName').val(),
                    description: $('#productDescription').val() || '',
                    price: parseFloat($('#productPrice').val()),
                    stock: parseFloat($('#productStock').val()),
                    imageUrl: imageUrl,
                    category: $('#productCategory').val() || '其他'
                };
                
                console.log('提交产品数据:', productData);
                
                // 提交产品数据
                const result = await http.post('/product', productData);
                console.log('产品保存响应:', result);
                
                if (result && result.code === 200) {
                    alert('产品添加成功');
                    $('#addProductModal').modal('hide');
                    $('#addProductForm')[0].reset(); // 重置表单
                    $('#imagePreview').attr('src', '../../img/no-image.png'); // 重置图片预览
                    $('#uploadStatus').hide(); // 隐藏上传状态
                    loadProducts(); // 重新加载产品列表
                } else {
                    throw new Error(result.message || '添加产品失败');
                }
            } catch (error) {
                console.error('添加产品失败', error);
                alert('添加产品失败: ' + error.message);
            } finally {
                $('#saveProductBtn').attr('disabled', false).html('保存产品');
            }
        }
        
        /**
         * 更新产品
         */
        async function updateProduct() {
            try {
                console.log('开始更新产品');
                $('#updateProductBtn').attr('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...');
                
                const productId = $('#editProductId').val();
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                // 检查是否需要上传新图片
                const imageFile = $('#editProductImage')[0].files[0];
                let imageUrl = null;
                
                if (imageFile) {
                    // 使用Promise方式处理图片上传
                    const uploadImage = () => {
                        return new Promise((resolve, reject) => {
                            uploadProductImage(imageFile, (url) => {
                                console.log('编辑模式：图片上传成功，URL:', url);
                                resolve(url);
                            });
                        });
                    };
                    
                    // 显示状态
                    $('#editUploadStatus').show().text('正在上传图片...');
                    
                    // 等待图片上传完成
                    imageUrl = await uploadImage();
                }
                
                // 收集产品数据
                const productData = {
                    farmerId: parseInt(user.userId),
                    productName: $('#editProductName').val(),
                    description: $('#editProductDescription').val() || '',
                    price: parseFloat($('#editProductPrice').val()),
                    stock: parseFloat($('#editProductStock').val()),
                    category: $('#editProductCategory').val() || '其他'
                };
                
                // 如果有新图片URL，则更新
                if (imageUrl) {
                    productData.imageUrl = imageUrl;
                }
                
                // 提交产品更新
                const result = await http.put(`/product/${productId}`, productData);
                
                console.log('产品更新响应:', result);
                
                if (result && result.code === 200) {
                    alert('产品更新成功');
                    $('#editProductModal').modal('hide');
                    $('#editUploadStatus').hide(); // 隐藏上传状态
                    loadProducts(); // 重新加载产品列表
                } else {
                    throw new Error(result.message || '更新产品失败');
                }
            } catch (error) {
                console.error('更新产品失败', error);
                alert('更新产品失败: ' + error.message);
            } finally {
                $('#updateProductBtn').attr('disabled', false).html('更新');
            }
        }
    </script>
</body>
</html> 
                $.ajax({
                    url: '/api/products',
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify(productData),
                    success: function(data) {
                        alert('产品添加成功');
                        $('#addProductModal').modal('hide');
                        $('#addProductForm')[0].reset(); // 重置表单
                        $('#imagePreview').attr('src', '../../img/no-image.png'); // 重置图片预览
                        loadProducts(); // 重新加载产品列表
                    },
                    error: function(xhr) {
                        console.error('添加产品失败', xhr);
                        alert('添加产品失败: ' + (xhr.responseJSON?.message || xhr.statusText));
                    }
                });
            });
        }
        
        /**
         * 更新产品
         */
        function updateProduct() {
            const token = localStorage.getItem('token');
            const productId = $('#editProductId').val();
            
            // 检查是否需要上传新图片
            const imageFile = $('#editProductImage')[0].files[0];
            
            if (imageFile) {
                // 如果有新图片，先上传图片
                uploadProductImage(imageFile, function(imageUrl) {
                    submitProductUpdate(productId, token, imageUrl);
                });
            } else {
                // 如果没有新图片，直接更新产品信息
                submitProductUpdate(productId, token);
            }
        }
        
        /**
         * 提交产品更新
         */
        function submitProductUpdate(productId, token, imageUrl) {
            // 收集产品数据
            const productData = {
                productId: parseInt(productId),
                name: $('#editProductName').val(),
                category: $('#editProductCategory').val(),
                price: parseFloat($('#editProductPrice').val()),
                stock: parseFloat($('#editProductStock').val()),
                description: $('#editProductDescription').val(),
                specification: $('#editProductSpecification').val(),
                isOrganic: $('#editIsOrganic').prop('checked'),
                harvestDate: $('#editHarvestDate').val() || null,
                shelfLife: $('#editShelfLife').val() ? parseInt($('#editShelfLife').val()) : null,
                status: $('#editProductStatus').val()
            };
            
            // 如果有新图片URL，则更新
            if (imageUrl) {
                productData.imageUrl = imageUrl;
            }
            
            // 提交产品数据
            $.ajax({
                url: '/api/products/' + productId,
                type: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(productData),
                success: function(data) {
                    alert('产品更新成功');
                    $('#editProductModal').modal('hide');
                    loadProducts(); // 重新加载产品列表
                },
                error: function(xhr) {
                    console.error('更新产品失败', xhr);
                    alert('更新产品失败: ' + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }
        
        /**
         * 上传产品图片
         */
        function uploadProductImage(file, callback) {
            const token = localStorage.getItem('token');
            const formData = new FormData();
            formData.append('file', file);
            
            $.ajax({
                url: '/api/upload/image',
                type: 'POST',
                data: formData,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                contentType: false,
                processData: false,
                success: function(data) {
                    callback(data.url);
                },
                error: function(xhr) {
                    console.error('上传图片失败', xhr);
                    alert('上传图片失败: ' + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }
        
        /**
         * 预览图片
         */
        function previewImage(input, previewSelector) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $(previewSelector).attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
                $(input).next('.custom-file-label').text(input.files[0].name);
            }
        }
    </script>
</body>
</html> 