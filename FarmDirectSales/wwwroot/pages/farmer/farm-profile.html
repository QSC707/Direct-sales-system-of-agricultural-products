<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>农场资料管理 - 农产品直销平台</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../../js/dependencies.js"></script>
    <!-- 引入Axios库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- API调用相关 -->
    <script src="../../js/api.js"></script>
    <!-- Axios配置 -->
    <script src="../../js/axios-config.js"></script>
    <script src="../../js/auth.js"></script>
    <style>
        .photo-upload-card {
            position: relative;
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        
        .photo-upload-card:hover {
            border-color: #007bff;
        }
        
        .photo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            text-align: center;
        }
        
        .farm-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }
        
        .photo-upload-card.has-image {
            border-style: solid;
            border-color: #28a745;
        }
        
        /* 新增优化样式 */
        .photo-upload-card.uploading {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        
        .photo-upload-card.error {
            border-color: #dc3545;
            box-shadow: 0 0 10px rgba(220,53,69,0.3);
        }
        
        .upload-progress {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            z-index: 5;
            background: rgba(255,255,255,0.9);
            padding: 5px;
            border-radius: 3px;
        }
        
        .progress {
            height: 20px;
            margin-bottom: 5px;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            width: 90%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .retry-btn {
            margin-top: 8px;
        }
        
        .photo-upload-card.disabled {
            pointer-events: none;
            opacity: 0.7;
        }
        
        /* ========== 移动端适配样式 ========== */
        
        /* 超大屏幕 (1200px 及以上) */
        @media (min-width: 1200px) {
            .photo-upload-card {
                height: 220px;
            }
            
            .photo-placeholder i {
                font-size: 3rem;
            }
        }
        
        /* 大屏幕 (992px 至 1199px) */
        @media (min-width: 992px) and (max-width: 1199px) {
            .photo-upload-card {
                height: 200px;
            }
        }
        
        /* 平板设备 (768px 至 991px) */
        @media (min-width: 768px) and (max-width: 991px) {
            .photo-upload-card {
                height: 180px;
                margin-bottom: 15px;
            }
            
            .photo-placeholder p {
                font-size: 14px;
                margin-top: 8px;
            }
            
            .photo-delete-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .upload-progress {
                padding: 8px;
            }
            
            .progress {
                height: 18px;
            }
            
            .error-message {
                padding: 12px;
                width: 95%;
            }
            
            /* 侧边栏在平板上隐藏，使用导航栏 */
            .sidebar-mobile {
                display: none;
            }
        }
        
        /* 小屏幕设备 (576px 至 767px) */
        @media (min-width: 576px) and (max-width: 767px) {
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .photo-upload-card {
                height: 160px;
                margin-bottom: 20px;
                border-width: 3px;
            }
            
            .photo-placeholder {
                padding: 10px;
            }
            
            .photo-placeholder i {
                font-size: 2.5rem;
            }
            
            .photo-placeholder p {
                font-size: 16px;
                margin-top: 10px;
                font-weight: 500;
            }
            
            .photo-delete-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
                top: 8px;
                right: 8px;
            }
            
            .upload-progress {
                padding: 10px;
                left: 8px;
                right: 8px;
                bottom: 8px;
            }
            
            .progress {
                height: 22px;
            }
            
            .progress-text {
                font-size: 14px;
                font-weight: 500;
            }
            
            .error-message {
                padding: 20px;
                width: 95%;
                font-size: 14px;
            }
            
            .retry-btn {
                margin-top: 12px;
                padding: 8px 16px;
                font-size: 14px;
            }
            
            /* 表单布局调整 */
            .card-header h4 {
                font-size: 18px;
            }
            
            .form-group label {
                font-size: 16px;
                font-weight: 600;
            }
            
            .form-control {
                font-size: 16px;
                padding: 12px;
            }
        }
        
        /* 超小屏幕设备 (575px 及以下) - 手机 */
        @media (max-width: 575px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .my-4 {
                margin: 15px 0;
            }
            
            /* 移动端单列布局 */
            .row {
                margin: 0;
            }
            
            .col-md-3, .col-md-9 {
                padding: 0;
                margin-bottom: 15px;
            }
            
            /* 隐藏侧边栏，使用移动端导航 */
            .col-md-3 {
                display: none;
            }
            
            .col-md-9 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .card {
                border-radius: 12px;
                box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            }
            
            .card-header {
                border-radius: 12px 12px 0 0;
                padding: 15px 20px;
            }
            
            .card-header h4 {
                font-size: 20px;
                margin: 0;
            }
            
            .card-body {
                padding: 20px;
            }
            
            /* 照片上传区域优化 */
            .photo-upload-card {
                height: 140px;
                margin-bottom: 15px;
                border-width: 3px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .photo-upload-card:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            .photo-placeholder {
                padding: 15px;
            }
            
            .photo-placeholder i {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .photo-placeholder p {
                font-size: 14px;
                margin: 0;
                font-weight: 600;
                line-height: 1.3;
            }
            
            .photo-delete-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                top: 10px;
                right: 10px;
                border-radius: 50%;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            .upload-progress {
                padding: 12px;
                left: 10px;
                right: 10px;
                bottom: 10px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .progress {
                height: 24px;
                border-radius: 12px;
                overflow: hidden;
            }
            
            .progress-bar {
                transition: width 0.3s ease;
            }
            
            .progress-text {
                font-size: 13px;
                font-weight: 600;
                color: #333;
            }
            
            .error-message {
                padding: 20px;
                width: 90%;
                font-size: 14px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }
            
            .error-text {
                font-weight: 600;
                line-height: 1.4;
            }
            
            .retry-btn {
                margin-top: 15px;
                padding: 10px 20px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 8px;
                min-height: 44px; /* 苹果建议的最小触摸区域 */
            }
            
            /* 表单优化 */
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 8px;
                color: #333;
            }
            
            .form-control {
                font-size: 16px;
                padding: 15px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
                min-height: 50px; /* 触摸友好 */
            }
            
            .form-control:focus {
                border-color: #007bff;
                box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            }
            
            textarea.form-control {
                min-height: 80px;
                resize: vertical;
            }
            
            select.form-control {
                background-size: 20px;
                padding-right: 45px;
            }
            
            .btn-primary {
                width: 100%;
                padding: 15px;
                font-size: 16px;
                font-weight: 600;
                border-radius: 8px;
                min-height: 50px;
                margin-top: 20px;
            }
            
            /* 小文本调整 */
            .text-muted {
                font-size: 13px;
                line-height: 1.4;
            }
            
            /* 照片网格布局 */
            #farmPhotosPreview .col-md-4 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }
            
            /* 状态颜色增强 */
            .photo-upload-card.uploading {
                border-color: #007bff;
                box-shadow: 0 0 15px rgba(0,123,255,0.4);
            }
            
            .photo-upload-card.error {
                border-color: #dc3545;
                box-shadow: 0 0 15px rgba(220,53,69,0.4);
            }
            
            .photo-upload-card.has-image {
                border-color: #28a745;
                box-shadow: 0 0 15px rgba(40,167,69,0.3);
            }
        }
        
        /* ========== 触摸设备通用优化 ========== */
        @media (hover: none) and (pointer: coarse) {
            /* 触摸设备特定样式 */
            .photo-upload-card:hover {
                border-color: #ddd; /* 禁用hover效果 */
            }
            
            .photo-upload-card:active {
                border-color: #007bff;
                transform: scale(0.98);
            }
            
            .btn:active {
                transform: scale(0.95);
            }
            
            /* 增大触摸区域 */
            .photo-delete-btn,
            .retry-btn {
                min-width: 44px;
                min-height: 44px;
            }
        }
        
        /* ========== 高像素密度屏幕优化 ========== */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .photo-upload-card {
                border-width: 0.5px;
            }
            
            .photo-upload-card.uploading,
            .photo-upload-card.error,
            .photo-upload-card.has-image {
                border-width: 1px;
            }
        }
        
        /* ========== 横屏模式优化 ========== */
        @media (max-width: 767px) and (orientation: landscape) {
            .photo-upload-card {
                height: 120px;
            }
            
            .photo-placeholder i {
                font-size: 1.5rem;
            }
            
            .photo-placeholder p {
                font-size: 12px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            #farmPhotosPreview .col-md-4 {
                flex: 0 0 50%;
                max-width: 50%;
                padding: 0 5px;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">农户中心</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">农户首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">商品管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">订单管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="delivery-settings.html">配送设置</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">销售统计</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                            <span id="currentUsername">用户</span>
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item active" href="farm-profile.html">农场资料</a>
                            <a class="dropdown-item" href="products.html">商品管理</a>
                            <a class="dropdown-item" href="orders.html">订单管理</a>
                            <a class="dropdown-item" href="delivery-settings.html">配送设置</a>
                            <a class="dropdown-item" href="statistics.html">销售统计</a>
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="../../index.html">返回网站首页</a>
                            <a class="dropdown-item" href="#" id="logoutBtn">退出登录</a>
                        </div>
                    </li>
                    <li class="nav-item" id="loginItem">
                        <a class="nav-link" href="../login.html">登录</a>
                    </li>
                    <li class="nav-item" id="registerItem">
                        <a class="nav-link" href="../register.html">注册</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container my-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="dashboard.html" class="list-group-item list-group-item-action">农户首页</a>
                    <a href="farm-profile.html" class="list-group-item list-group-item-action active">农场资料</a>
                    <a href="products.html" class="list-group-item list-group-item-action">商品管理</a>
                    <a href="orders.html" class="list-group-item list-group-item-action">订单管理</a>
                    <a href="delivery-settings.html" class="list-group-item list-group-item-action">配送设置</a>
                    <a href="statistics.html" class="list-group-item list-group-item-action">销售统计</a>
                    <a href="profile.html" class="list-group-item list-group-item-action">个人信息</a>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4>农场资料管理</h4>
                    </div>
                    <div class="card-body">
                        <!-- 农场信息表单 -->
                        <form id="farmProfileForm">
                            <div class="form-group">
                                <label for="farmName">农场名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="farmName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="location">农场位置 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="location" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="description">农场简介</label>
                                <textarea class="form-control" id="description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="productCategory">主要产品类别</label>
                                <select class="form-control" id="productCategory">
                                    <option value="">请选择</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="水果">水果</option>
                                    <option value="谷物">谷物</option>
                                    <option value="肉类">肉类</option>
                                    <option value="奶制品">奶制品</option>
                                    <option value="蛋类">蛋类</option>
                                    <option value="水产品">水产品</option>
                                    <option value="干货">干货</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="licenseNumber">营业执照号码</label>
                                <input type="text" class="form-control" id="licenseNumber">
                            </div>
                            
                            <div class="form-group">
                                <label for="establishedDate">成立日期</label>
                                <input type="date" class="form-control" id="establishedDate">
                                    </div>
                            
                            <!-- 农场照片上传 -->
                            <div class="form-group">
                                <label>农场照片 <small class="text-muted">(最多3张)</small></label>
                                <div class="farm-photos-container">
                                    <!-- 照片预览区域 -->
                                    <div class="row mb-3" id="farmPhotosPreview">
                                        <div class="col-md-4 mb-2">
                                            <div class="photo-upload-card" data-index="1">
                                                <img id="farmPhoto1" src="" alt="农场照片1" class="farm-photo-img" style="display: none;">
                                                <div class="photo-placeholder">
                                                    <i class="fa fa-camera fa-2x"></i>
                                                    <p>点击上传照片1</p>
                                </div>
                                                <button type="button" class="btn btn-sm btn-danger photo-delete-btn" style="display: none;">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                                <!-- 上传进度条 -->
                                                <div class="upload-progress" style="display: none;">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-primary" style="width: 0%"></div>
                                                    </div>
                                                    <div class="progress-text text-center">上传进度: 0%</div>
                                                </div>
                                                <!-- 错误信息 -->
                                                <div class="error-message" style="display: none;">
                                                    <i class="fa fa-exclamation-triangle text-danger"></i>
                                                    <div class="error-text text-danger">上传失败</div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary retry-btn">重试</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="photo-upload-card" data-index="2">
                                                <img id="farmPhoto2" src="" alt="农场照片2" class="farm-photo-img" style="display: none;">
                                                <div class="photo-placeholder">
                                                    <i class="fa fa-camera fa-2x"></i>
                                                    <p>点击上传照片2</p>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-danger photo-delete-btn" style="display: none;">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                                <!-- 上传进度条 -->
                                                <div class="upload-progress" style="display: none;">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-primary" style="width: 0%"></div>
                                                    </div>
                                                    <div class="progress-text text-center">上传进度: 0%</div>
                                                </div>
                                                <!-- 错误信息 -->
                                                <div class="error-message" style="display: none;">
                                                    <i class="fa fa-exclamation-triangle text-danger"></i>
                                                    <div class="error-text text-danger">上传失败</div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary retry-btn">重试</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="photo-upload-card" data-index="3">
                                                <img id="farmPhoto3" src="" alt="农场照片3" class="farm-photo-img" style="display: none;">
                                                <div class="photo-placeholder">
                                                    <i class="fa fa-camera fa-2x"></i>
                                                    <p>点击上传照片3</p>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-danger photo-delete-btn" style="display: none;">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                                <!-- 上传进度条 -->
                                                <div class="upload-progress" style="display: none;">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-primary" style="width: 0%"></div>
                                                    </div>
                                                    <div class="progress-text text-center">上传进度: 0%</div>
                                                </div>
                                                <!-- 错误信息 -->
                                                <div class="error-message" style="display: none;">
                                                    <i class="fa fa-exclamation-triangle text-danger"></i>
                                                    <div class="error-text text-danger">上传失败</div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary retry-btn">重试</button>
                                                </div>
                                            </div>
                                </div>
                            </div>
                            
                                    <!-- 隐藏的文件输入框 -->
                                    <input type="file" id="farmPhotoInput" accept="image/*" style="display: none;">
                                    
                                    <small class="form-text text-muted">
                                        支持 JPG、PNG、GIF、WebP 格式，每张图片不超过5MB
                                    </small>
                                </div>
                            </div>
                            
                            <div class="text-right">
                                <button type="submit" class="btn btn-primary">保存修改</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p>© 2023 农产品直销平台 版权所有</p>
        </div>
    </footer>

    <!-- 自定义JS -->
    <script>
        /**
         * 页面加载完成后执行
         */
        document.addEventListener('DOMContentLoaded', function() {
            // 使用initDependencies确保jQuery加载
            window.initDependencies(function() {
                // jQuery已加载完成，可以安全使用
                
                // 检查用户是否登录，并且是农户角色
                checkLogin(function(user) {
                    if (user && user.role === 'farmer') {
                        // 显示用户信息
                        $('#userDropdown').show();
                        $('#currentUsername').text(user.username);
                        
                        // 加载农场资料
                        loadFarmProfile();
                    } else {
                        // 如果不是农户，跳转到登录页面
                        alert('您需要以农户身份登录才能访问此页面');
                        window.location.href = '../login.html?role=farmer&redirect=' + encodeURIComponent(window.location.href);
                    }
                });
                
                // 绑定表单提交事件
                $('#farmProfileForm').on('submit', function(e) {
                    e.preventDefault();
                    saveFarmerProfile();
                });
                
                // 绑定照片上传事件
                initPhotoUpload();
                
                // 退出登录按钮点击事件
                $('#logoutBtn').on('click', function() {
                    logout();
                    window.location.href = '../login.html';
                });
            });
        });
        
        /**
         * 加载农户资料
         */
        async function loadFarmProfile() {
            try {
                const userId = JSON.parse(localStorage.getItem('user') || '{}').userId;
                if (!userId) {
                    throw new Error('未找到用户ID');
                }
                
                console.log('开始加载农户ID为', userId, '的农场资料');
                
                // 使用Axios通过http接口获取用户信息
                const result = await http.get(`farmerprofile/${userId}`);
                console.log('获取到农场资料:', result);
                
                // 如果用户有农户资料，则填充表单
                if (result.code === 200 && result.data) {
                    $('#farmName').val(result.data.farmName || '');
                    $('#location').val(result.data.location || '');
                    $('#description').val(result.data.description || '');
                    $('#productCategory').val(result.data.productCategory || '');
                    $('#licenseNumber').val(result.data.licenseNumber || '');
                    $('#establishedDate').val(result.data.establishedDate ? result.data.establishedDate.substring(0, 10) : '');
                    
                    // 显示农场照片 - 修复数据结构
                    console.log('获取到的农场资料数据:', result.data);
                    const photos = [
                        result.data.farmPhoto1,
                        result.data.farmPhoto2,
                        result.data.farmPhoto3
                    ].filter(photo => photo && photo.trim() !== ''); // 过滤掉空值和空字符串
                    
                    console.log('处理后的农场照片数组:', photos);
                    displayFarmPhotos(photos);
                } else {
                    console.log('农场资料不存在或为空，显示空表单');
                    // 显示空的照片占位符
                    displayFarmPhotos([]);
                }
            } catch (error) {
                console.error('获取用户信息失败', error);
                // 不弹出错误提示，只在控制台记录，让用户可以创建新的农场资料
                console.log('将显示空的农场资料表单供用户创建');
                // 显示空的照片占位符
                displayFarmPhotos([]);
            }
        }
        
        /**
         * 保存农户资料
         */
        async function saveFarmerProfile() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = user.userId;
                
                if (!userId) {
                    throw new Error('未找到用户ID');
                }
                
                // 收集表单数据
                const farmData = {
                    farmName: $('#farmName').val(),
                    location: $('#location').val(),
                    description: $('#description').val(),
                    productCategory: $('#productCategory').val(),
                    licenseNumber: $('#licenseNumber').val(),
                    establishedDate: $('#establishedDate').val()
                };
                
                // 保存农场资料
                await saveProfileData(userId, farmData);
            } catch (error) {
                console.error('保存过程中出错:', error);
                alert('保存过程中出错: ' + error.message);
            }
        }
        
        /**
         * 保存农场资料数据
         */
        async function saveProfileData(userId, farmData) {
            try {
                console.log('保存农场资料:', farmData);
                
                // 格式化日期
                const formattedData = {
                    userId: userId,
                    farmName: farmData.farmName,
                    location: farmData.location,
                    description: farmData.description || '',
                    productCategory: farmData.productCategory || '',
                    licenseNumber: farmData.licenseNumber || '',
                    establishedDate: farmData.establishedDate ? new Date(farmData.establishedDate).toISOString() : null
                };
                
                // 使用Axios发送请求
                const response = await http.post('farmerprofile', formattedData);
                
                if (response && response.code === 200) {
                    console.log('农场资料保存成功');
                    alert('农场资料保存成功');
                    
                    // 重新加载农场资料
                    await loadFarmProfile();
                } else {
                    throw new Error('保存失败: ' + (response.message || '未知错误'));
                }
                    } catch (error) {
                console.error('保存农场资料失败', error);
                alert('保存农场资料失败: ' + error.message);
            }
        }
        
        // 当前选择的照片索引
        let currentPhotoIndex = 1;
        
        // 防重复上传机制 - 跟踪正在上传的照片
        let uploadingPhotos = new Set();
        
        // 移动端检测
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // 错误信息映射
        const errorMessages = {
            'FILE_TOO_LARGE': '文件大小超过5MB，请选择较小的图片',
            'INVALID_FORMAT': '不支持的文件格式，请选择JPG、PNG、GIF或WebP格式',
            'NETWORK_ERROR': '网络错误，请检查网络连接后重试',
            'PERMISSION_DENIED': '权限不足，无法上传照片',
            'SERVER_ERROR': '服务器错误，请稍后重试',
            'TOKEN_EXPIRED': '登录已过期，请重新登录'
        };
        
        /**
         * 移动端优化函数
         */
        function initMobileOptimizations() {
            if (isMobile || isTouch) {
                console.log('检测到移动设备，启用移动端优化');
                
                // 添加移动端专用类
                $('body').addClass('mobile-device');
                
                // 优化触摸反馈
                $('.photo-upload-card').on('touchstart', function() {
                    $(this).addClass('touch-active');
                }).on('touchend touchcancel', function() {
                    $(this).removeClass('touch-active');
                });
                
                // 防止双击缩放（在照片区域）
                $('.photo-upload-card').on('touchend', function(e) {
                    e.preventDefault();
                });
                
                // 移动端文件选择优化
                $('#farmPhotoInput').attr('capture', 'environment'); // 优先使用后置摄像头
                
                // 添加移动端提示
                $('.farm-photos-container .text-muted').html(`
                    支持 JPG、PNG、GIF、WebP 格式，每张图片不超过5MB<br>
                    <small class="text-info"><i class="fa fa-mobile"></i> 移动端可直接拍照上传</small>
                `);
                
                // 移动端键盘处理
                $('input, textarea, select').on('focus', function() {
                    setTimeout(() => {
                        $(this)[0].scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300);
                });
            }
        }
        
        /**
         * 添加触摸手势支持
         */
        function initTouchGestures() {
            if (!isTouch) return;
            
            let touchStartX = 0;
            let touchStartY = 0;
            
            $('.photo-upload-card').on('touchstart', function(e) {
                const touch = e.originalEvent.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
            });
            
            $('.photo-upload-card').on('touchmove', function(e) {
                e.preventDefault(); // 防止滚动
            });
            
            $('.photo-upload-card').on('touchend', function(e) {
                const touch = e.originalEvent.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;
                
                const deltaX = Math.abs(touchEndX - touchStartX);
                const deltaY = Math.abs(touchEndY - touchStartY);
                
                // 如果移动距离很小，认为是点击
                if (deltaX < 10 && deltaY < 10) {
                    $(this).trigger('click');
                }
            });
        }
        
        /**
         * 移动端网络状态监听
         */
        function initNetworkMonitoring() {
            if ('navigator' in window && 'onLine' in navigator) {
                // 网络状态变化监听
                window.addEventListener('online', function() {
                    console.log('网络已连接');
                    $('.network-status').remove();
                });
                
                window.addEventListener('offline', function() {
                    console.log('网络已断开');
                    showNetworkWarning();
                });
                
                // 初始网络状态检查
                if (!navigator.onLine) {
                    showNetworkWarning();
                }
            }
        }
        
        /**
         * 显示网络警告
         */
        function showNetworkWarning() {
            const warningHtml = `
                <div class="alert alert-warning network-status" role="alert">
                    <i class="fa fa-wifi"></i> 网络连接断开，上传功能可能受影响
                </div>
            `;
            
            if ($('.network-status').length === 0) {
                $('.card-header').after(warningHtml);
            }
        }
        
        /**
         * 移动端相机权限检查
         */
        async function checkCameraPermission() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                return false;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.log('相机权限检查失败:', error);
                return false;
            }
        }
        
        /**
         * 移动端专用错误显示
         */
        function showMobileError(error, photoIndex) {
            if (isMobile) {
                // 移动端使用更明显的错误提示
                const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
                
                // 添加震动反馈（如果支持）
                if ('vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                // 显示错误信息
                showDetailedError(error, photoIndex);
                
                // 自动滚动到错误位置
                setTimeout(() => {
                    card[0].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 100);
            } else {
                showDetailedError(error, photoIndex);
            }
        }
        
        /**
         * 显示详细错误信息
         */
        function showDetailedError(error, photoIndex) {
            const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
            const errorContainer = card.find('.error-message');
            const errorText = card.find('.error-text');
            
            // 确定错误类型和消息
            let errorType = 'UNKNOWN';
            let message = error.message || '上传失败，请重试';
            
            if (error.message) {
                if (error.message.includes('大小') || error.message.includes('5MB')) {
                    errorType = 'FILE_TOO_LARGE';
                } else if (error.message.includes('格式') || error.message.includes('类型')) {
                    errorType = 'INVALID_FORMAT';
                } else if (error.message.includes('网络') || error.message.includes('Network')) {
                    errorType = 'NETWORK_ERROR';
                } else if (error.message.includes('权限') || error.message.includes('Forbidden')) {
                    errorType = 'PERMISSION_DENIED';
                } else if (error.message.includes('服务器') || error.code >= 500) {
                    errorType = 'SERVER_ERROR';
                } else if (error.message.includes('token') || error.code === 401) {
                    errorType = 'TOKEN_EXPIRED';
                }
            }
            
            message = errorMessages[errorType] || message;
            
            // 显示错误信息
            errorText.text(message);
            errorContainer.show();
            card.addClass('error').removeClass('uploading');
            
            // 绑定重试按钮事件
            card.find('.retry-btn').off('click').on('click', function(e) {
                e.stopPropagation();
                hideError(photoIndex);
                selectPhoto(photoIndex);
            });
            
            console.error(`照片${photoIndex}上传失败:`, error);
        }
        
        /**
         * 隐藏错误信息
         */
        function hideError(photoIndex) {
            const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
            card.find('.error-message').hide();
            card.removeClass('error');
        }
        
        /**
         * 显示上传进度
         */
        function showUploadProgress(photoIndex, progress) {
            const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
            const progressContainer = card.find('.upload-progress');
            const progressBar = card.find('.progress-bar');
            const progressText = card.find('.progress-text');
            
            progressBar.css('width', progress + '%');
            progressText.text(`上传进度: ${progress}%`);
            progressContainer.show();
        }
        
        /**
         * 隐藏上传进度
         */
        function hideUploadProgress(photoIndex) {
            const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
            card.find('.upload-progress').hide();
        }
        
        /**
         * 选择照片
         */
        function selectPhoto(index) {
            currentPhotoIndex = index;
            $('#farmPhotoInput').click();
        }
        
        /**
         * 初始化照片上传功能 - 优化版本
         */
        function initPhotoUpload() {
            // 绑定文件选择事件（先移除旧的事件监听器）
            $('#farmPhotoInput').off('change').on('change', function() {
                const file = this.files[0];
                if (file && !uploadingPhotos.has(currentPhotoIndex)) {
                    uploadFarmPhoto(file, currentPhotoIndex);
                } else if (uploadingPhotos.has(currentPhotoIndex)) {
                    alert('照片正在上传中，请稍候...');
                }
            });
            
            // 绑定照片卡片点击事件（先移除旧的事件监听器）
            $('.photo-upload-card').off('click').on('click', function(e) {
                const $target = $(e.target);
                
                // 如果点击的是删除按钮或重试按钮，不触发上传
                if ($target.closest('.photo-delete-btn, .retry-btn').length > 0) {
                    return;
                }
                
                const index = parseInt($(this).data('index'));
                
                // 检查是否正在上传
                if (uploadingPhotos.has(index)) {
                    alert('照片正在上传中，请稍候...');
                    return;
                }
                
                // 隐藏任何错误信息
                hideError(index);
                
                selectPhoto(index);
            });
        }
        
        /**
         * 上传农场照片 - 优化版本
         */
        async function uploadFarmPhoto(file, photoIndex) {
            // 防重复上传检查
            if (uploadingPhotos.has(photoIndex)) {
                alert('照片正在上传中，请稍候...');
                return;
            }
            
            const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
            
            try {
                // 添加到上传队列
                uploadingPhotos.add(photoIndex);
                
                // 隐藏错误信息
                hideError(photoIndex);
                
                // 设置上传状态
                card.addClass('uploading disabled');
                
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const farmerId = user.userId;
                
                if (!farmerId) {
                    throw new Error('未找到用户ID，请重新登录');
                }
                
                // 详细的文件验证
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('不支持的文件格式，请选择JPG、PNG、GIF或WebP格式');
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    throw new Error('文件大小超过5MB，请选择较小的图片');
                }
                
                // 显示初始进度
                showUploadProgress(photoIndex, 0);
                
                // 创建FormData
                const formData = new FormData();
                formData.append('photo', file);
                
                // 模拟进度更新
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    showUploadProgress(photoIndex, Math.round(progress));
                }, 200);
                
                // 使用XMLHttpRequest以支持进度监控
                const uploadPromise = new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    
                    // 上传进度事件
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            showUploadProgress(photoIndex, percentComplete);
                        }
                    });
                    
                    // 上传完成事件
                    xhr.addEventListener('load', () => {
                        clearInterval(progressInterval);
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                resolve(result);
                            } catch (e) {
                                reject(new Error('服务器响应格式错误'));
                            }
                        } else if (xhr.status === 401) {
                            reject(new Error('登录已过期，请重新登录'));
                        } else if (xhr.status === 403) {
                            reject(new Error('权限不足，无法上传照片'));
                        } else if (xhr.status >= 500) {
                            reject(new Error('服务器错误，请稍后重试'));
                } else {
                            reject(new Error(`上传失败 (${xhr.status})`));
                        }
                    });
                    
                    // 网络错误事件
                    xhr.addEventListener('error', () => {
                        clearInterval(progressInterval);
                        reject(new Error('网络错误，请检查网络连接后重试'));
                    });
                    
                    // 超时事件
                    xhr.addEventListener('timeout', () => {
                        clearInterval(progressInterval);
                        reject(new Error('上传超时，请重试'));
                    });
                    
                    // 配置请求
                    xhr.open('POST', `/api/upload/farm-photo/${farmerId}/${photoIndex}`);
                    xhr.setRequestHeader('Authorization', `Bearer ${localStorage.getItem('token')}`);
                    xhr.timeout = 30000; // 30秒超时
                    
                    // 发送请求
                    xhr.send(formData);
                });
                
                const result = await uploadPromise;
                
                // 完成进度显示
                showUploadProgress(photoIndex, 100);
                
                if (result.code === 200) {
                    console.log('照片上传成功:', result);
                    
                    // 延迟隐藏进度条，让用户看到100%
                    setTimeout(() => {
                        hideUploadProgress(photoIndex);
                        
                        // 重新加载农场资料以显示新照片
                        loadFarmProfile().then(() => {
                            // 显示成功提示
                            const placeholder = card.find('.photo-placeholder');
                            placeholder.html('<i class="fa fa-check-circle fa-2x text-success"></i><p class="text-success">上传成功</p>');
                            
                            setTimeout(() => {
                                // 2秒后恢复正常显示
                                loadFarmProfile();
                            }, 2000);
                        });
                    }, 500);
                } else {
                    throw new Error(result.message || '上传失败');
                }
                
            } catch (error) {
                console.error('上传农场照片失败:', error);
                
                // 隐藏进度条
                hideUploadProgress(photoIndex);
                
                // 显示详细错误信息
                showMobileError(error, photoIndex);
                
            } finally {
                // 从上传队列中移除
                uploadingPhotos.delete(photoIndex);
                
                // 移除上传状态
                card.removeClass('uploading disabled');
                
                // 清空文件输入框，允许重新选择同一个文件
                $('#farmPhotoInput').val('');
            }
        }
        
        /**
         * 删除农场照片
         */
        async function deleteFarmPhoto(photoIndex) {
            if (!confirm('确定要删除这张照片吗？')) {
                return;
            }
            
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const farmerId = user.userId;
                
                if (!farmerId) {
                    throw new Error('未找到用户ID');
                }
                
                // 发送删除请求
                const response = await fetch(`/api/upload/farm-photos/${farmerId}/${photoIndex}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    console.log('照片删除成功:', result);
                    
                    // 重新加载农场资料以移除照片显示
                    await loadFarmProfile();
                    
                    alert('照片删除成功');
                } else {
                    throw new Error(result.message || '删除失败');
                }
            } catch (error) {
                console.error('删除农场照片失败:', error);
                alert('删除失败: ' + error.message);
            }
        }
        
        /**
         * 显示农场照片 - 优化版本
         */
        function displayFarmPhotos(photos) {
            console.log('开始显示农场照片:', photos);
            
            for (let i = 0; i < 3; i++) {
                const photoIndex = i + 1;
                const photoUrl = photos && photos[i] ? photos[i] : null;
                const card = $(`.photo-upload-card[data-index="${photoIndex}"]`);
                const img = card.find('.farm-photo-img');
                const placeholder = card.find('.photo-placeholder');
                const deleteBtn = card.find('.photo-delete-btn');
                
                console.log(`处理照片${photoIndex}:`, photoUrl);
                
                // 清理所有状态
                card.removeClass('has-image uploading error disabled');
                hideUploadProgress(photoIndex);
                hideError(photoIndex);
                
                if (photoUrl && photoUrl.trim() !== '') {
                    // 显示照片
                    img.attr('src', photoUrl).show();
                    placeholder.hide();
                    deleteBtn.show();
                    card.addClass('has-image');
                    
                    // 绑定删除按钮事件（移除旧的事件监听器以避免重复绑定）
                    deleteBtn.off('click').on('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        
                        // 防止在上传过程中删除
                        if (uploadingPhotos.has(photoIndex)) {
                            alert('照片正在上传中，请稍候...');
                            return;
                        }
                        
                        deleteFarmPhoto(photoIndex);
                    });
                    
                    console.log(`照片${photoIndex}显示成功`);
                } else {
                    // 显示占位符
                    img.hide().attr('src', '');
                    placeholder.show();
                    deleteBtn.hide();
                    placeholder.html(`<i class="fa fa-camera fa-2x"></i><p>点击上传照片${photoIndex}</p>`);
                    
                    console.log(`照片${photoIndex}显示占位符`);
                }
            }
        }
    </script>
</body>
</html> 