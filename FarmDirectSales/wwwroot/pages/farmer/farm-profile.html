<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>农场资料管理 - 农产品直销平台</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../../js/dependencies.js"></script>
    <!-- 引入Axios库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- API调用相关 -->
    <script src="../../js/api.js"></script>
    <!-- Axios配置 -->
    <script src="../../js/axios-config.js"></script>
    <script src="../../js/auth.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">农户中心</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">农户首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">我的产品</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">订单管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">销售统计</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                            <span id="currentUsername">用户</span>
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="farm-profile.html">农场资料</a>
                            <a class="dropdown-item" href="products.html">我的产品</a>
                            <a class="dropdown-item" href="orders.html">订单管理</a>
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="../../index.html">返回网站首页</a>
                            <a class="dropdown-item" href="#" id="logoutBtn">退出登录</a>
                        </div>
                    </li>
                    <li class="nav-item" id="loginItem">
                        <a class="nav-link" href="../login.html">登录</a>
                    </li>
                    <li class="nav-item" id="registerItem">
                        <a class="nav-link" href="../register.html">注册</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container my-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="farm-profile.html" class="list-group-item list-group-item-action active">农场资料</a>
                    <a href="products.html" class="list-group-item list-group-item-action">我的产品</a>
                    <a href="orders.html" class="list-group-item list-group-item-action">订单管理</a>
                    <a href="statistics.html" class="list-group-item list-group-item-action">销售统计</a>
                    <a href="profile.html" class="list-group-item list-group-item-action">个人信息</a>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4>农场资料管理</h4>
                    </div>
                    <div class="card-body">
                        <!-- 农场信息表单 -->
                        <form id="farmProfileForm">
                            <div class="form-group">
                                <label for="farmName">农场名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="farmName" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="location">农场位置 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="location" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="description">农场简介</label>
                                <textarea class="form-control" id="description" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="productCategory">主要产品类别</label>
                                <select class="form-control" id="productCategory">
                                    <option value="">请选择</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="水果">水果</option>
                                    <option value="谷物">谷物</option>
                                    <option value="肉类">肉类</option>
                                    <option value="奶制品">奶制品</option>
                                    <option value="蛋类">蛋类</option>
                                    <option value="水产品">水产品</option>
                                    <option value="干货">干货</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="licenseNumber">营业执照号码</label>
                                <input type="text" class="form-control" id="licenseNumber">
                            </div>
                            
                            <div class="form-group">
                                <label for="logoUpload">农场LOGO</label>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="logoUpload" accept="image/*">
                                        <label class="custom-file-label" for="logoUpload">选择文件</label>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <img id="logoPreview" src="../../img/default-farm-logo.png" alt="农场LOGO" class="img-thumbnail" style="max-width: 150px;">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="establishedDate">成立日期</label>
                                <input type="date" class="form-control" id="establishedDate">
                            </div>
                            
                            <div class="text-right">
                                <button type="submit" class="btn btn-primary">保存修改</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p>© 2023 农产品直销平台 版权所有</p>
        </div>
    </footer>

    <!-- 自定义JS -->
    <script>
        /**
         * 页面加载完成后执行
         */
        $(document).ready(function() {
            // 检查用户是否登录，并且是农户角色
            checkLogin(function(user) {
                if (user && user.role === 'farmer') {
                    // 显示用户信息
                    $('#userDropdown').show();
                    $('#currentUsername').text(user.username);
                    
                    // 加载农场资料
                    loadFarmProfile();
                } else {
                    // 如果不是农户，跳转到登录页面
                    alert('您需要以农户身份登录才能访问此页面');
                    window.location.href = '../login.html?role=farmer&redirect=' + encodeURIComponent(window.location.href);
                }
            });
            
            // 绑定表单提交事件
            $('#farmProfileForm').on('submit', function(e) {
                e.preventDefault();
                saveFarmerProfile();
            });
            
            // Logo上传预览
            $('#logoUpload').on('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#logoPreview').attr('src', e.target.result);
                    }
                    reader.readAsDataURL(file);
                    $('.custom-file-label').text(file.name);
                }
            });
        });
        
        /**
         * 加载农户资料
         */
        async function loadFarmProfile() {
            try {
                const userId = JSON.parse(localStorage.getItem('user') || '{}').userId;
                if (!userId) {
                    throw new Error('未找到用户ID');
                }
                
                // 使用Axios通过http接口获取用户信息
                const result = await http.get(`/users/${userId}`);
                const data = result.data;
                
                // 如果用户有农户资料，则填充表单
                if (data.farmerProfile) {
                    $('#farmName').val(data.farmerProfile.farmName);
                    $('#location').val(data.farmerProfile.location);
                    $('#description').val(data.farmerProfile.description);
                    $('#productCategory').val(data.farmerProfile.productCategory);
                    $('#licenseNumber').val(data.farmerProfile.licenseNumber);
                    $('#establishedDate').val(data.farmerProfile.establishedDate ? data.farmerProfile.establishedDate.substring(0, 10) : '');
                    
                    // 更新LOGO预览
                    if (data.farmerProfile.logoUrl) {
                        $('#logoPreview').attr('src', data.farmerProfile.logoUrl);
                    }
                }
            } catch (error) {
                console.error('获取用户信息失败', error);
                alert('获取用户信息失败: ' + (error.response?.data?.message || error.message));
            }
        }
        
        /**
         * 保存农户资料
         */
        async function saveFarmerProfile() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = user.userId;
                
                if (!userId) {
                    throw new Error('未找到用户ID');
                }
                
                // 收集表单数据
                const farmData = {
                    farmName: $('#farmName').val(),
                    location: $('#location').val(),
                    description: $('#description').val(),
                    productCategory: $('#productCategory').val(),
                    licenseNumber: $('#licenseNumber').val(),
                    establishedDate: $('#establishedDate').val()
                };
                
                // 首先上传Logo（如果有选择文件）
                const logoFile = $('#logoUpload')[0].files[0];
                if (logoFile) {
                    try {
                        // 上传Logo成功后，保存农场资料
                        const logoUrl = await uploadLogo(logoFile);
                        farmData.logoUrl = logoUrl;
                    } catch (error) {
                        // 上传失败但不阻止保存其他资料
                        console.warn('Logo上传失败，将继续保存其他农场资料');
                    }
                }
                
                // 保存农场资料
                await saveProfileData(userId, farmData);
            } catch (error) {
                console.error('保存过程中出错:', error);
                alert('保存过程中出错: ' + error.message);
            }
        }
        
        /**
         * 上传农场Logo
         */
        async function uploadLogo(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // 使用Axios上传文件
                const response = await axios.post('/api/upload/image', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        'Authorization': `Bearer ${window.getToken()}`
                    }
                });
                
                return response.data.url;
            } catch (error) {
                console.error('上传Logo失败', error);
                alert('上传Logo失败: ' + (error.response?.data?.message || error.message));
                throw error;
            }
        }
        
        /**
         * 保存农场资料数据
         */
        async function saveProfileData(userId, farmData) {
            try {
                // 使用Axios发送请求
                const response = await http.post('/farmer/profile', {
                    userId: userId,
                    ...farmData
                });
                
                alert('农场资料保存成功');
                // 重新加载农场资料
                await loadFarmProfile();
            } catch (error) {
                console.error('保存农场资料失败', error);
                alert('保存农场资料失败: ' + (error.response?.data?.message || error.message));
            }
        }
    </script>
</body>
</html> 