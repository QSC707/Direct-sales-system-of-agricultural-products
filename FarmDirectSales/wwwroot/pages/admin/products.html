<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品管理 - 农产品直销平台</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../../js/dependencies.js"></script>
    <!-- 引入Axios库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- API调用相关 -->
    <script src="../../js/api.js"></script>
    <!-- Axios配置 -->
    <script src="../../js/axios-config.js"></script>
    <script src="../../js/auth.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">管理中心</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">管理首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">用户管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">产品管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">订单管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">统计分析</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userDropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                            <span id="currentUsername">管理员</span>
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="dashboard.html">管理中心</a>
                            <a class="dropdown-item" href="users.html">用户管理</a>
                            <a class="dropdown-item" href="products.html">产品管理</a>
                            <a class="dropdown-item" href="orders.html">订单管理</a>
                            <a class="dropdown-item" href="logs.html">系统日志</a>
                            <a class="dropdown-item" href="profile.html">个人信息</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="../../index.html">返回网站首页</a>
                            <a class="dropdown-item" href="#" id="logoutBtn">退出登录</a>
                        </div>
                    </li>
                    <li class="nav-item" id="loginItem">
                        <a class="nav-link" href="../login.html">登录</a>
                    </li>
                    <li class="nav-item" id="registerItem">
                        <a class="nav-link" href="../register.html">注册</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container my-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="dashboard.html" class="list-group-item list-group-item-action">管理中心</a>
                    <a href="users.html" class="list-group-item list-group-item-action">用户管理</a>
                    <a href="products.html" class="list-group-item list-group-item-action active">产品管理</a>
                    <a href="orders.html" class="list-group-item list-group-item-action">订单管理</a>
                    <a href="statistics.html" class="list-group-item list-group-item-action">统计分析</a>
                    <a href="reviews.html" class="list-group-item list-group-item-action">评价管理</a>
                    <a href="logs.html" class="list-group-item list-group-item-action">系统日志</a>
                    <a href="profile.html" class="list-group-item list-group-item-action">个人信息</a>
                </div>
            </div>
            
            <!-- 主要内容 -->
            <div class="col-md-9">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">产品管理</h4>
                        <div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="搜索产品...">
                                <div class="input-group-append">
                                    <button class="btn btn-light" id="searchBtn">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选器 -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <select class="form-control" id="categoryFilter">
                                        <option value="">所有类别</option>
                                        <option value="蔬菜">蔬菜</option>
                                        <option value="水果">水果</option>
                                        <option value="谷物">谷物</option>
                                        <option value="肉类">肉类</option>
                                        <option value="奶制品">奶制品</option>
                                        <option value="蛋类">蛋类</option>
                                        <option value="水产品">水产品</option>
                                        <option value="干货">干货</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="statusFilter">
                                        <option value="">所有状态</option>
                                        <option value="上架">上架</option>
                                        <option value="下架">下架</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="sortOrder">
                                        <option value="newest">最新上架</option>
                                        <option value="priceAsc">价格从低到高</option>
                                        <option value="priceDesc">价格从高到低</option>
                                        <option value="popular">最受欢迎</option>
                                        <option value="rating">评分最高</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary btn-block" id="resetFilter">
                                        <i class="fa fa-refresh"></i> 重置筛选
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 产品列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>产品图片</th>
                                        <th>名称</th>
                                        <th>价格(元/kg)</th>
                                        <th>库存(kg)</th>
                                        <th>农户</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="productList">
                                    <!-- 产品列表将通过JS动态加载 -->
                                    <tr>
                                        <td colspan="8" class="text-center">正在加载产品...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控制 -->
                        <nav class="d-flex justify-content-between align-items-center">
                            <div>
                                <span>共 <span id="totalItems">0</span> 个产品，每页 <select id="pageSize" class="form-control form-control-sm d-inline-block" style="width: 60px;">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select> 条</span>
                            </div>
                            <ul class="pagination" id="pagination">
                                <!-- 分页将通过JS动态加载 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 产品详情模态框 -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productDetailModalLabel">产品详情</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <img id="detailProductImage" src="../../img/no-image.png" alt="产品图片" class="img-fluid rounded">
                        </div>
                        <div class="col-md-7">
                            <h4 id="detailProductName"></h4>
                            <div class="mb-3">
                                <span class="badge badge-success mr-2" id="detailProductCategory"></span>
                                <span class="badge badge-info mr-2" id="detailProductStatus"></span>
                                <div class="mt-2">
                                    <span class="text-warning">
                                        <i class="fa fa-star"></i>
                                        <span id="detailProductRating">0.0</span>
                                    </span>
                                    <span class="text-muted ml-2">(<span id="detailProductReviews">0</span>条评价)</span>
                                </div>
                            </div>
                            <hr>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <strong>价格：</strong>
                                    <span class="text-danger" id="detailProductPrice">0.00</span> 元/kg
                                </div>
                                <div class="col-6">
                                    <strong>库存：</strong>
                                    <span id="detailProductStock">0</span> kg
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <strong>农户：</strong>
                                    <span id="detailProductFarmer"></span>
                                </div>
                                <div class="col-6">
                                    <strong>上架时间：</strong>
                                    <span id="detailProductCreateTime"></span>
                                </div>
                            </div>
                            <div class="mb-2">
                                <strong>产品描述：</strong>
                                <p id="detailProductDescription" class="text-muted"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger" id="adminDeleteProductBtn">删除产品</button>
                    <button type="button" class="btn btn-warning" id="adminToggleStatusBtn">上架/下架</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p>© 2023 农产品直销平台 版权所有</p>
        </div>
    </footer>

    <!-- 自定义JS -->
    <script>
        /**
         * 页面加载完成后执行
         */
        $(document).ready(function() {
            // 检查用户是否登录，并且是管理员角色
            checkLogin(function(user) {
                if (user && user.role === 'admin') {
                    // 显示用户信息
                    $('#userDropdown').show();
                    $('#currentUsername').text(user.username);
                    
                    // 初始化分页信息
                    let currentPage = 1;
                    let pageSize = parseInt($('#pageSize').val());
                    
                    // 加载产品数据
                    loadProducts(currentPage, pageSize);
                    
                    // 绑定分页大小变更事件
                    $('#pageSize').on('change', function() {
                        pageSize = parseInt($(this).val());
                        currentPage = 1; // 切换页面大小时回到第一页
                        loadProducts(currentPage, pageSize);
                    });
                    
                    // 绑定筛选器事件
                    $('#categoryFilter, #statusFilter, #sortOrder').on('change', function() {
                        currentPage = 1; // 筛选时回到第一页
                        loadProducts(currentPage, pageSize);
                    });
                    
                    // 绑定搜索事件
                    $('#searchBtn').on('click', function() {
                        currentPage = 1; // 搜索时回到第一页
                        loadProducts(currentPage, pageSize);
                    });
                    
                    // 回车键搜索
                    $('#searchInput').on('keypress', function(e) {
                        if (e.which === 13) {
                            currentPage = 1;
                            loadProducts(currentPage, pageSize);
                        }
                    });
                    
                    // 绑定重置筛选器事件
                    $('#resetFilter').on('click', function() {
                        $('#searchInput').val('');
                        $('#categoryFilter').val('');
                        $('#statusFilter').val('');
                        $('#sortOrder').val('newest');
                        currentPage = 1;
                        loadProducts(currentPage, pageSize);
                    });
                    
                    // 绑定删除产品按钮事件
                    $('#adminDeleteProductBtn').on('click', function() {
                        const productId = $(this).data('product-id');
                        if (confirm('确定要删除这个产品吗？此操作无法撤销')) {
                            deleteProduct(productId);
                        }
                    });
                    
                    // 绑定上架/下架按钮事件
                    $('#adminToggleStatusBtn').on('click', function() {
                        const productId = $(this).data('product-id');
                        const currentStatus = $(this).data('current-status');
                        const newStatus = currentStatus === '上架' ? '下架' : '上架';
                        
                        if (confirm(`确定要将产品状态改为"${newStatus}"吗？`)) {
                            toggleProductStatus(productId, newStatus);
                        }
                    });
                } else {
                    // 如果不是管理员，跳转到登录页面
                    alert('您需要以管理员身份登录才能访问此页面');
                    window.location.href = '../login.html?role=admin&redirect=' + encodeURIComponent(window.location.href);
                }
            });
        });
        
        /**
         * 加载产品列表
         */
        async function loadProducts(page, pageSize) {
            try {
                // 获取筛选条件
                const category = $('#categoryFilter').val();
                const status = $('#statusFilter').val();
                const sortOrder = $('#sortOrder').val();
                const searchTerm = $('#searchInput').val();
                
                // 构建查询参数
                const params = {
                    page: page,
                    pageSize: pageSize
                };
                
                if (category) params.category = category;
                if (status) params.status = status;
                if (sortOrder) params.sort = sortOrder;
                if (searchTerm) params.search = searchTerm;
                
                // 使用Axios获取产品列表
                const response = await http.get('/products', { params });
                
                if (response.status === 200 && response.data) {
                    const { data, totalItems, totalPages } = response.data;
                    
                    // 更新总数量显示
                    $('#totalItems').text(totalItems);
                    
                    // 渲染产品列表
                    renderProductList(data);
                    
                    // 渲染分页控件
                    renderPagination(page, totalPages, function(newPage) {
                        loadProducts(newPage, pageSize);
                    });
                } else {
                    throw new Error('获取产品列表失败');
                }
            } catch (error) {
                console.error('加载产品列表失败', error);
                alert('加载产品列表失败: ' + (error.response?.data?.message || error.message));
                
                // 显示错误信息
                $('#productList').html('<tr><td colspan="8" class="text-center text-danger">加载产品失败，请重试</td></tr>');
                $('#pagination').empty();
            }
        }
        
        /**
         * 渲染产品列表
         */
        function renderProductList(products) {
            const $productList = $('#productList');
            $productList.empty();
            
            if (!products || products.length === 0) {
                $productList.html('<tr><td colspan="8" class="text-center">没有找到符合条件的产品</td></tr>');
                return;
            }
            
            // 渲染产品列表
            products.forEach(function(product) {
                const statusClass = product.status === '上架' ? 'badge-success' : 'badge-secondary';
                
                const row = `
                    <tr>
                        <td>${product.productId}</td>
                        <td>
                            <img src="${product.imageUrl || '../../img/no-image.png'}" alt="${product.productName}" class="img-thumbnail" style="max-width: 60px;">
                        </td>
                        <td>${product.productName}</td>
                        <td>${product.price.toFixed(2)}</td>
                        <td>${product.stock.toFixed(1)}</td>
                        <td>${product.farmer.username}</td>
                        <td><span class="badge ${statusClass}">${product.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info view-product-btn" data-product-id="${product.productId}">
                                查看
                            </button>
                            <button class="btn btn-sm btn-danger delete-product-btn" data-product-id="${product.productId}">
                                删除
                            </button>
                        </td>
                    </tr>
                `;
                
                $productList.append(row);
            });
            
            // 绑定查看和删除事件
            $('.view-product-btn').on('click', function() {
                const productId = $(this).data('product-id');
                viewProductDetail(productId);
            });
            
            $('.delete-product-btn').on('click', function() {
                const productId = $(this).data('product-id');
                if (confirm('确定要删除这个产品吗？此操作无法撤销')) {
                    deleteProduct(productId);
                }
            });
        }
        
        /**
         * 渲染分页控件
         */
        function renderPagination(currentPage, totalPages, callback) {
            const $pagination = $('#pagination');
            $pagination.empty();
            
            // 如果总页数小于等于1，不显示分页
            if (totalPages <= 1) {
                return;
            }
            
            // 添加上一页按钮
            $pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>
                </li>
            `);
            
            // 计算显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // 调整起始页，确保始终显示5个页码（如果总页数足够）
            if (endPage - startPage < 4 && totalPages > 5) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                $pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }
            
            // 添加下一页按钮
            $pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>
                </li>
            `);
            
            // 绑定页码点击事件
            $('.page-link').on('click', function(e) {
                e.preventDefault();
                
                // 如果是禁用状态则不执行
                if ($(this).parent().hasClass('disabled')) {
                    return;
                }
                
                const page = parseInt($(this).data('page'));
                callback(page);
            });
        }
        
        /**
         * 查看产品详情
         */
        async function viewProductDetail(productId) {
            try {
                // 使用Axios获取产品详情
                const response = await http.get(`/products/${productId}`);
                
                if (response.status === 200 && response.data) {
                    const product = response.data.data;
                    
                    // 填充模态框数据
                    $('#detailProductName').text(product.productName);
                    $('#detailProductCategory').text(product.category || '未分类');
                    $('#detailProductStatus').text(product.status || '未知状态');
                    $('#detailProductPrice').text(product.price.toFixed(2));
                    $('#detailProductStock').text(product.stock.toFixed(1));
                    $('#detailProductRating').text(product.averageRating?.toFixed(1) || '0.0');
                    $('#detailProductReviews').text(product.reviewCount || 0);
                    $('#detailProductFarmer').text(product.farmer.username);
                    $('#detailProductCreateTime').text(formatDate(product.createTime));
                    $('#detailProductDescription').text(product.description || '暂无描述');
                    
                    // 设置产品图片
                    if (product.imageUrl) {
                        $('#detailProductImage').attr('src', product.imageUrl);
                    } else {
                        $('#detailProductImage').attr('src', '../../img/no-image.png');
                    }
                    
                    // 设置操作按钮的数据
                    $('#adminDeleteProductBtn').data('product-id', product.productId);
                    $('#adminToggleStatusBtn').data('product-id', product.productId);
                    $('#adminToggleStatusBtn').data('current-status', product.status);
                    
                    // 根据产品状态调整按钮文字
                    const buttonText = product.status === '上架' ? '下架产品' : '上架产品';
                    $('#adminToggleStatusBtn').text(buttonText);
                    
                    // 显示模态框
                    $('#productDetailModal').modal('show');
                } else {
                    throw new Error('获取产品详情失败');
                }
            } catch (error) {
                console.error('加载产品详情失败', error);
                alert('加载产品详情失败: ' + (error.response?.data?.message || error.message));
            }
        }
        
        /**
         * 删除产品
         */
        async function deleteProduct(productId) {
            try {
                // 使用Axios删除产品
                const response = await http.delete(`/products/${productId}`);
                
                if (response.status === 200) {
                    alert('产品删除成功');
                    
                    // 关闭产品详情模态框（如果打开）
                    $('#productDetailModal').modal('hide');
                    
                    // 重新加载产品列表
                    const currentPage = parseInt($('.pagination .active .page-link').data('page')) || 1;
                    const pageSize = parseInt($('#pageSize').val());
                    loadProducts(currentPage, pageSize);
                } else {
                    throw new Error('删除产品失败');
                }
            } catch (error) {
                console.error('删除产品失败', error);
                alert('删除产品失败: ' + (error.response?.data?.message || error.message));
            }
        }
        
        /**
         * 切换产品状态（上架/下架）
         */
        async function toggleProductStatus(productId, newStatus) {
            try {
                // 使用Axios更新产品状态
                const response = await http.put(`/products/${productId}/status`, {
                    status: newStatus
                });
                
                if (response.status === 200) {
                    alert(`产品已${newStatus}`);
                    
                    // 关闭产品详情模态框
                    $('#productDetailModal').modal('hide');
                    
                    // 重新加载产品列表
                    const currentPage = parseInt($('.pagination .active .page-link').data('page')) || 1;
                    const pageSize = parseInt($('#pageSize').val());
                    loadProducts(currentPage, pageSize);
                } else {
                    throw new Error(`${newStatus}产品失败`);
                }
            } catch (error) {
                console.error(`${newStatus}产品失败`, error);
                alert(`${newStatus}产品失败: ` + (error.response?.data?.message || error.message));
            }
        }
        
        /**
         * 格式化日期
         */
        function formatDate(dateString) {
            if (!dateString) return '未知';
            
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
    </script>
</body>
</html> 
 
 